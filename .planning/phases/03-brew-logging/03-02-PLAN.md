---
phase: 03-brew-logging
plan: 02
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - CoffeeJournal/ViewModels/BrewLogViewModel.swift
  - CoffeeJournal/Views/Brewing/BrewTimerView.swift
  - CoffeeJournal/Views/Brewing/BrewStepGuideView.swift
  - CoffeeJournal/Utilities/BrewStepTemplates.swift
  - CoffeeJournal/Views/Brewing/AddBrewLogView.swift
autonomous: true

must_haves:
  truths:
    - "User can start, pause, resume, and stop a brew timer within the brew log form"
    - "Timer displays elapsed time in M:SS.t format updating in real time"
    - "Stopping the timer records the elapsed time as the brew's brewTime"
    - "User can toggle step-by-step guidance that shows brew steps for the selected method category"
    - "User sees which brew step is currently active and can skip to the next step manually"
    - "Pour-over shows bloom/pour/drawdown steps, espresso shows pre-infusion/extraction, immersion shows add-water/steep/plunge"
  artifacts:
    - path: "CoffeeJournal/Views/Brewing/BrewTimerView.swift"
      provides: "Timer UI with start/pause/resume/stop/reset buttons and M:SS.t display"
      min_lines: 50
    - path: "CoffeeJournal/Views/Brewing/BrewStepGuideView.swift"
      provides: "Step-by-step guidance overlay showing current step name, description, and progress"
      min_lines: 30
    - path: "CoffeeJournal/Utilities/BrewStepTemplates.swift"
      provides: "Static brew step data for each MethodCategory"
      exports: ["BrewStep", "BrewStepTemplate"]
  key_links:
    - from: "CoffeeJournal/Views/Brewing/BrewTimerView.swift"
      to: "CoffeeJournal/ViewModels/BrewLogViewModel.swift"
      via: "Timer.publish + onReceive updating viewModel.elapsedSeconds"
      pattern: "onReceive.*timer"
    - from: "CoffeeJournal/Views/Brewing/BrewStepGuideView.swift"
      to: "CoffeeJournal/Utilities/BrewStepTemplates.swift"
      via: "BrewStepTemplate.steps(for: category)"
      pattern: "BrewStepTemplate\\.steps"
    - from: "CoffeeJournal/Views/Brewing/AddBrewLogView.swift"
      to: "CoffeeJournal/Views/Brewing/BrewTimerView.swift"
      via: "Timer section replaces manual Steppers with BrewTimerView"
      pattern: "BrewTimerView"
---

<objective>
Add integrated brew timer with state machine controls and optional step-by-step guidance per method category to the brew log form.

Purpose: The timer transforms brew logging from post-hoc data entry into real-time brew tracking. Step guidance helps newer brewers follow method-appropriate timing (bloom, pour stages, steep time). This is key differentiator BREW-08 and BREW-11.

Output: BrewTimerView (embedded timer component), BrewStepGuideView (optional step overlay), BrewStepTemplates (static step data), ViewModel timer methods, AddBrewLogView updated with timer section replacing manual Steppers.
</objective>

<execution_context>
@/Users/ashok/.claude/get-shit-done/workflows/execute-plan.md
@/Users/ashok/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/03-brew-logging/03-RESEARCH.md
@.planning/phases/03-brew-logging/03-01-SUMMARY.md
@CoffeeJournal/ViewModels/BrewLogViewModel.swift
@CoffeeJournal/Views/Brewing/AddBrewLogView.swift
@CoffeeJournal/Models/MethodCategory.swift
@CoffeeJournal/Views/Components/MonochromeStyle.swift
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create BrewStepTemplates and add timer methods to ViewModel</name>
  <files>CoffeeJournal/Utilities/BrewStepTemplates.swift, CoffeeJournal/ViewModels/BrewLogViewModel.swift</files>
  <action>
**BrewStepTemplates.swift** -- Create static brew step data:

1. Define `struct BrewStep: Identifiable` with: `let id = UUID()`, `let name: String`, `let description: String`, `let durationSeconds: Int` (0 = untimed/manual advance), `let waterPercentage: Double?` (nil = N/A).

2. Define `struct BrewStepTemplate` with static func `steps(for category: MethodCategory) -> [BrewStep]`:

Pour-over steps:
- "Bloom" / "Pour 2x dose weight, let CO2 escape" / 30s / 0.13
- "First Pour" / "Slow spiral to 60% total water" / 30s / 0.47
- "Second Pour" / "Pour remaining water in slow spiral" / 30s / 0.40
- "Drawdown" / "Wait for water to drain" / 90s / nil

Espresso steps:
- "Pre-infusion" / "Low pressure water contact" / 5s / nil
- "Extraction" / "Full pressure extraction" / 25s / nil

Immersion steps:
- "Add Water" / "Pour all water over grounds" / 10s / 1.0
- "Steep" / "Wait for extraction" / 240s / nil
- "Plunge/Filter" / "Separate grounds from brew" / 30s / nil

Other:
- "Brew" / "Follow your method's process" / 0s / nil

Import Foundation and the MethodCategory type.

**BrewLogViewModel.swift** -- Add timer control methods and step guidance state:

1. Add step guidance properties:
- `var guidanceEnabled: Bool = false`
- `var currentStepIndex: Int = 0`
- `var stepElapsedSeconds: TimeInterval = 0` (time within current step)

2. Add computed property `var currentSteps: [BrewStep]` that returns `BrewStepTemplate.steps(for: selectedMethod?.category ?? .other)`.

3. Add computed property `var currentStep: BrewStep?` that returns `currentSteps[safe: currentStepIndex]` (guard index bounds).

4. Add timer control methods:
- `func startTimer()` -- Set timerStartDate = Date(), timerState = .running, stepElapsedSeconds = 0.
- `func pauseTimer()` -- Set pausedElapsed = elapsedSeconds, timerState = .paused.
- `func resumeTimer()` -- Set timerStartDate = Date(), timerState = .running.
- `func stopTimer()` -- Set timerState = .stopped, brewTime = elapsedSeconds.
- `func resetTimer()` -- Set timerState = .idle, timerStartDate = nil, pausedElapsed = 0, elapsedSeconds = 0, currentStepIndex = 0, stepElapsedSeconds = 0.

5. Add `func updateTimer()` -- Called from view's onReceive. Guard timerState == .running and timerStartDate exists. Calculate `elapsedSeconds = pausedElapsed + Date().timeIntervalSince(timerStartDate!)`. If guidanceEnabled, track stepElapsedSeconds and auto-advance: calculate cumulative duration of steps up to currentStepIndex, compare with total elapsedSeconds, advance currentStepIndex when step duration exceeded.

6. Add `func advanceStep()` -- Manual step advancement. Increment currentStepIndex if within bounds.
  </action>
  <verify>
Run `swift build` from the project root. BrewStepTemplates.swift compiles with BrewStep and BrewStepTemplate types. BrewLogViewModel compiles with timer methods and step guidance state.
  </verify>
  <done>
BrewStepTemplates provides category-specific brew guidance data. BrewLogViewModel has full timer state machine (idle/running/paused/stopped) with Date-based elapsed time calculation (no drift), step guidance tracking with auto-advance, and manual step advancement.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create BrewTimerView, BrewStepGuideView, and replace manual Steppers in AddBrewLogView</name>
  <files>CoffeeJournal/Views/Brewing/BrewTimerView.swift, CoffeeJournal/Views/Brewing/BrewStepGuideView.swift, CoffeeJournal/Views/Brewing/AddBrewLogView.swift</files>
  <action>
NOTE: This task MUST run after Task 1, because it depends on the timer methods and step guidance properties added to BrewLogViewModel in Task 1.

**BrewTimerView.swift** -- Create the embedded timer component:

1. Accept `@Bindable var viewModel: BrewLogViewModel`.
2. Create `let timer = Timer.publish(every: 0.1, on: .main, in: .common).autoconnect()`.
3. Layout as VStack(spacing: AppSpacing.md):

Top: Large monospaced time display `Text(formattedTime).font(.system(size: 48, weight: .light, design: .monospaced)).foregroundStyle(AppColors.primary)`.

Middle: Control buttons in HStack(spacing: AppSpacing.lg), switching on viewModel.timerState:
- `.idle` -> "Start" button with .monochromeButtonStyle()
- `.running` -> "Pause" + "Stop" buttons
- `.paused` -> "Resume" + "Stop" buttons
- `.stopped` -> "Reset" button

Bottom (conditionally): If viewModel.selectedMethod != nil, show Toggle("Step Guide", isOn: $viewModel.guidanceEnabled). Only show when timer is idle or stopped (not while running/paused -- don't change guidance mid-brew).

4. Add `.onReceive(timer)` that calls `viewModel.updateTimer()`.

5. Add private `formattedTime` computed property: Convert viewModel.elapsedSeconds to "M:SS.t" format using integer division (minutes = total / 60, seconds = total % 60, tenths = fractional * 10).

**BrewStepGuideView.swift** -- Create the step guidance display:

1. Accept `@Bindable var viewModel: BrewLogViewModel`.
2. Only render when `viewModel.guidanceEnabled && viewModel.currentStep != nil`.
3. Layout as VStack(spacing: AppSpacing.sm):

Step progress: `Text("Step \(viewModel.currentStepIndex + 1) of \(viewModel.currentSteps.count)").font(AppTypography.caption).foregroundStyle(AppColors.subtle)`.

Current step name: `Text(step.name).font(AppTypography.headline)`.

Current step description: `Text(step.description).font(AppTypography.body).foregroundStyle(AppColors.secondary)`.

Step duration indicator: If step.durationSeconds > 0, show a ProgressView or text showing remaining time in current step. Use viewModel.stepElapsedSeconds against step.durationSeconds.

Water amount hint: If step.waterPercentage != nil and viewModel.waterAmount > 0, show calculated water for this step: `Text("\(Int(step.waterPercentage! * viewModel.waterAmount))g water")`.

Manual advance button: `Button("Next Step") { viewModel.advanceStep() }.monochromeButtonStyle()` -- shown when step.durationSeconds == 0 (untimed step) or as override.

4. Style with a subtle background (AppColors.secondaryBackground) and rounded corners to visually distinguish from the rest of the form.

**AddBrewLogView.swift** -- Replace the manual brew time Steppers section with the timer:

1. Find the "Brew Time" Section that contains the minutes Stepper, seconds Stepper, and total time display (created in Plan 03-01 Task 2). Replace its entire contents with:
- `BrewTimerView(viewModel: viewModel)` -- the timer controls
- `BrewStepGuideView(viewModel: viewModel)` -- step guidance (renders only when enabled)
- Below the timer, show a small manual override: `Text("or enter manually")` with the original minutes/seconds Steppers (Stepper for viewModel.brewTimeMinutes 0...60 and viewModel.brewTimeSeconds 0...59). Only show manual entry when timerState == .idle (timer not started).

2. Rename the Section header from "Brew Time" to "Brew Timer".

3. Ensure the existing brew time manual entry still works as fallback: if timerState == .stopped, use timer's recorded time. If timerState == .idle and manual time entered, use manual time. The viewModel.saveBrew already handles this via brewTime / manualBrewTimeTotal logic.

4. Do NOT add NavigationStack or modify the sheet presentation structure. Only modify the form content within the "Brew Time" section.
  </action>
  <verify>
Run `swift build` from the project root. All three files compile. BrewTimerView shows timer display and controls. BrewStepGuideView shows step guidance when enabled. AddBrewLogView includes timer section that replaced the manual-only Steppers.
  </verify>
  <done>
Brew timer is fully integrated into the brew log form with start/pause/resume/stop controls, M:SS.t display, optional step-by-step guidance per method category (pour-over bloom/pour/drawdown, espresso pre-infusion/extraction, immersion steep), and manual time entry fallback. Timer uses Date-based calculation to prevent drift across pause/resume cycles. The manual Steppers from Plan 03-01 are preserved as a fallback within the timer section.
  </done>
</task>

</tasks>

<verification>
- `swift build` passes with no errors
- BrewTimerView displays elapsed time in real-time M:SS.t format
- Timer state machine transitions: idle -> running -> paused -> running -> stopped
- Stop action records elapsed seconds as brewTime
- Reset returns to idle state
- Step guidance toggle shows/hides BrewStepGuideView
- Pour-over steps: Bloom (30s) -> First Pour (30s) -> Second Pour (30s) -> Drawdown (90s)
- Espresso steps: Pre-infusion (5s) -> Extraction (25s)
- Immersion steps: Add Water (10s) -> Steep (240s) -> Plunge/Filter (30s)
- Steps auto-advance when duration exceeded
- Manual "Next Step" button available for untimed steps
- Water amount hints display calculated grams per step
- Manual brew time entry still works as fallback when timer not used
</verification>

<success_criteria>
Requirements covered: BREW-08 (integrated timer for brew time), BREW-10 (method-specific steep time for immersion via step guidance), BREW-11 (step-by-step guidance per method).

The brew timer is embedded in the form (not full-screen), step guidance is optional (toggle), and the manual time entry fallback serves users who don't want to use the timer.
</success_criteria>

<output>
After completion, create `.planning/phases/03-brew-logging/03-02-SUMMARY.md`
</output>
