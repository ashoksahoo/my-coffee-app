---
phase: 03-brew-logging
plan: 03
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - CoffeeJournal/Views/Brewing/BrewLogListView.swift
  - CoffeeJournal/Views/Brewing/BrewLogRow.swift
  - CoffeeJournal/Views/Brewing/BrewLogDetailView.swift
  - CoffeeJournal/Views/Brewing/AddBrewLogView.swift
  - CoffeeJournal/Views/MainTabView.swift
autonomous: true

must_haves:
  truths:
    - "User can see a chronological list of all brew logs with key info at a glance"
    - "User can tap a brew log to see full detail with all parameters"
    - "User can delete a brew log from the list"
    - "User can add a photo to a brew log"
    - "Brews tab appears as the first tab in the app"
    - "Empty state shown when no brews exist with prompt to log first brew"
    - "Brew logs sync across devices via iCloud (inherits SwiftData CloudKit config)"
  artifacts:
    - path: "CoffeeJournal/Views/Brewing/BrewLogListView.swift"
      provides: "Chronological brew log list with + button to create new brews"
      min_lines: 40
    - path: "CoffeeJournal/Views/Brewing/BrewLogRow.swift"
      provides: "List row showing brew method, coffee, date, ratio, rating"
      min_lines: 25
    - path: "CoffeeJournal/Views/Brewing/BrewLogDetailView.swift"
      provides: "Read-only detail view showing all brew parameters, photo, rating, notes"
      min_lines: 60
  key_links:
    - from: "CoffeeJournal/Views/Brewing/BrewLogListView.swift"
      to: "CoffeeJournal/Views/Brewing/AddBrewLogView.swift"
      via: ".sheet presenting AddBrewLogView wrapped in NavigationStack"
      pattern: "sheet.*AddBrewLogView"
    - from: "CoffeeJournal/Views/Brewing/BrewLogListView.swift"
      to: "CoffeeJournal/Views/Brewing/BrewLogDetailView.swift"
      via: "NavigationLink from list row to detail"
      pattern: "NavigationLink.*BrewLogDetailView"
    - from: "CoffeeJournal/Views/MainTabView.swift"
      to: "CoffeeJournal/Views/Brewing/BrewLogListView.swift"
      via: "First tab in TabView wraps BrewLogListView in NavigationStack"
      pattern: "BrewLogListView"
---

<objective>
Create brew log list view, row component, detail view, add photo support to the brew form, and wire the Brews tab as the first tab in the app.

Purpose: Users need to browse their brew history, view brew details, and access brew logging from the main tab bar. Photos complete the journaling experience. This plan makes brew logging accessible and browsable.

Output: BrewLogListView (chronological list), BrewLogRow (summary row), BrewLogDetailView (full detail), photo section in AddBrewLogView, Brews tab as first tab.
</objective>

<execution_context>
@/Users/ashok/.claude/get-shit-done/workflows/execute-plan.md
@/Users/ashok/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/03-brew-logging/03-RESEARCH.md
@.planning/phases/03-brew-logging/03-01-SUMMARY.md
@CoffeeJournal/Views/Brewing/AddBrewLogView.swift
@CoffeeJournal/Models/BrewLog.swift
@CoffeeJournal/Views/MainTabView.swift
@CoffeeJournal/Views/Beans/BeanListView.swift
@CoffeeJournal/Views/Beans/BeanRow.swift
@CoffeeJournal/Views/Components/EmptyStateView.swift
@CoffeeJournal/Views/Equipment/EquipmentPhotoPickerView.swift
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create BrewLogRow, BrewLogListView, and BrewLogDetailView</name>
  <files>CoffeeJournal/Views/Brewing/BrewLogRow.swift, CoffeeJournal/Views/Brewing/BrewLogListView.swift, CoffeeJournal/Views/Brewing/BrewLogDetailView.swift</files>
  <action>
**BrewLogRow.swift** -- Create list row component following BeanRow pattern:

1. Accept `let brew: BrewLog`.
2. Layout as HStack with VStack for text content:

Left side (VStack, alignment: .leading, spacing: AppSpacing.xs):
- Primary line: brew method name (`brew.brewMethod?.name ?? "Unknown Method"`) in AppTypography.headline
- Secondary line: coffee bean display (`brew.coffeeBean?.displayName ?? "No coffee selected"`) in AppTypography.body with AppColors.secondary
- Third line: HStack of key stats in AppTypography.caption with AppColors.subtle:
  - Ratio: brew.brewRatioFormatted (e.g., "1:16.2")
  - Separator dot " . "
  - Dose: "\(brew.dose, specifier: "%.1f")g"
  - Separator dot " . "
  - Time: brew.brewTimeFormatted (e.g., "3:45")

Right side:
- Date in AppTypography.caption, AppColors.subtle, formatted with `.dateStyle(.abbreviated)` (e.g., "Feb 9")
- Below date: if brew.rating > 0, show star count as HStack of small `star.fill` icons (AppTypography.caption size), count = brew.rating

3. Add small vertical padding for comfortable tap targets.

**BrewLogListView.swift** -- Create the brew list following BeanListView pattern:

1. Parent view `BrewLogListView` with `@State private var showingAddSheet = false`.
2. Body: BrewLogListContent() child view.
3. `.navigationTitle("Brews")`.
4. Toolbar: `+` button (Image(systemName: "plus"), .foregroundStyle(AppColors.primary)) that sets showingAddSheet = true.
5. `.sheet(isPresented: $showingAddSheet)` presenting `NavigationStack { AddBrewLogView() }`.

6. Child view `BrewLogListContent` with `@Query(sort: \BrewLog.createdAt, order: .reverse) private var brews: [BrewLog]` and `@Environment(\.modelContext)`.
7. If brews.isEmpty: `EmptyStateView(systemImage: "cup.and.saucer", title: "No Brews Yet", message: "Log your first brew to start tracking")`.
8. Else: List with ForEach(brews) -> NavigationLink to BrewLogDetailView(brew:) with BrewLogRow(brew:) as label.
9. Swipe-to-delete: `.swipeActions(edge: .trailing, allowsFullSwipe: false)` with destructive delete Button calling `modelContext.delete(brew)`.
10. `.listStyle(.plain)`.

**BrewLogDetailView.swift** -- Create read-only detail view:

1. Accept `let brew: BrewLog`.
2. Layout as ScrollView with VStack(alignment: .leading, spacing: AppSpacing.lg):

**Photo section** (if brew.photoData exists): Show image using `Image(uiImage: UIImage(data:)!)` full-width, 200pt height, scaledToFill, clipped with rounded corners.

**Equipment section** with header "Equipment":
- Brew method: `brew.brewMethod?.name ?? "Unknown"` with category icon
- Grinder: `brew.grinder?.name ?? "None"` with grind setting if grinderSetting > 0
- Coffee: `brew.coffeeBean?.displayName ?? "None"`

**Parameters section** with header "Parameters":
- Dose: "\(brew.dose, specifier: "%.1f")g"
- Water: "\(brew.waterAmount, specifier: "%.0f")g" (hide if 0 and espresso)
- Yield: "\(brew.yieldAmount, specifier: "%.1f")g" (only show if > 0 -- espresso)
- Temperature: "\(brew.waterTemperature, specifier: "%.0f") C" (hide if 0)
- Pressure: brew.pressureProfile (only show if non-empty)
- Brew time: brew.brewTimeFormatted
- Ratio: brew.brewRatioFormatted -- display prominently with AppTypography.title

Each parameter as HStack { Text(label).foregroundStyle(AppColors.secondary), Spacer(), Text(value) }.

**Rating section** (if brew.rating > 0): Show filled stars using same pattern as StarRatingView but non-interactive (just Image icons).

**Notes section** (if brew.notes is non-empty): Header "Notes" with Text(brew.notes) body text.

**Metadata section**: "Logged \(brew.createdAt, format: .dateTime.month().day().year().hour().minute())" in AppTypography.caption, AppColors.subtle.

3. `.navigationTitle("Brew Detail")` with `.navigationBarTitleDisplayMode(.inline)`.
4. Padding with AppSpacing.md on the VStack.
  </action>
  <verify>
Run `swift build` from the project root. BrewLogRow, BrewLogListView, and BrewLogDetailView compile without errors. List uses @Query sorted by createdAt descending. NavigationLink wires row to detail. Empty state shows when no brews exist.
  </verify>
  <done>
Brew log list displays chronological brew history with method name, coffee, ratio, dose, time, date, and star rating per row. Detail view shows full brew parameters organized by section (equipment, parameters, rating, notes, metadata) with photo display. List supports swipe-to-delete and has empty state for first-time users.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add photo section to AddBrewLogView, wire Brews tab, and verify iCloud sync</name>
  <files>CoffeeJournal/Views/Brewing/AddBrewLogView.swift, CoffeeJournal/Views/MainTabView.swift</files>
  <action>
**AddBrewLogView.swift** -- Add photo section to the brew log form:

1. Add `@State private var photoData: Data?` (or if ViewModel already has photoData, use that).
2. Add a "Photo" Section to the Form (place it after the Rating & Notes section):
- Embed `EquipmentPhotoPickerView(photoData: $viewModel.photoData)` (or $photoData if using local state -- ensure it flows to the ViewModel's save method).
- The existing EquipmentPhotoPickerView handles PhotosPicker presentation, image compression via ImageCompressor, loading states, and remove functionality. No custom photo code needed.
3. Ensure viewModel.saveBrew sets `log.photoData = photoData` (or viewModel.photoData). If photoData is not already on the ViewModel, add `var photoData: Data?` to BrewLogViewModel and include it in saveBrew's property assignment.

**MainTabView.swift** -- Add Brews tab as the first tab:

1. Add a new Brews tab BEFORE the Beans tab:
```
NavigationStack {
    BrewLogListView()
}
.tabItem {
    Label("Brews", systemImage: "mug")
}
```

2. Use SF Symbol "mug" for the Brews tab icon (simple, distinct from "cup.and.saucer" used for Methods).

3. Final tab order: Brews, Beans, Methods, Grinders, Settings. This reflects the app's primary value -- brew logging is the core action and should be the default landing tab.

4. Keep `.tint(Color.primary)` on TabView for monochrome enforcement.

5. Do NOT modify any other tab's content or NavigationStack structure.

**iCloud sync verification** -- Verify BrewLog syncs via the existing CloudKit ModelContainer:

1. After building, verify that the ModelContainer in CoffeeJournalApp.swift includes BrewLog in its schema (it should -- BrewLog was defined in SchemaV1 from Phase 1). No additional CloudKit configuration is needed for BrewLog sync.
2. Verify BrewLog model follows CloudKit safety rules: all properties have defaults, relationships are optional, no unique constraints. This was established in Phase 1 and adding grinderSetting (with default 0) in Plan 03-01 maintains compliance.
3. In the verification step, confirm these CloudKit-safe patterns exist in the compiled BrewLog model by reading the file and checking: default values on all stored properties, optional relationship types (BrewMethod?, Grinder?, CoffeeBean?), @Attribute(.externalStorage) on photoData.
  </action>
  <verify>
Run `swift build` from the project root. AddBrewLogView includes photo picker section using EquipmentPhotoPickerView. MainTabView has 5 tabs with Brews first. All files compile without errors.

Additionally verify iCloud sync readiness:
- Read CoffeeJournalApp.swift and confirm BrewLog is included in the ModelContainer schema
- Read BrewLog.swift and confirm all stored properties have defaults, all relationships are optional, and photoData uses @Attribute(.externalStorage)
- These checks confirm BREW-15 (iCloud sync) without requiring a physical multi-device test
  </verify>
  <done>
Photo support added to brew log form using existing EquipmentPhotoPickerView component (no new photo code). Brews tab wired as first tab in MainTabView with "mug" SF Symbol. Tab order: Brews, Beans, Methods, Grinders, Settings. iCloud sync verified: BrewLog is included in the CloudKit-backed ModelContainer schema with all CloudKit safety rules satisfied (default values, optional relationships, external storage for photos). The full brew logging flow is accessible from the app's primary tab and will sync across devices automatically.
  </done>
</task>

</tasks>

<verification>
- `swift build` passes with no errors
- BrewLogListView shows chronological list sorted by createdAt descending
- BrewLogRow displays method name, coffee, ratio, dose, time, date, and star rating
- BrewLogDetailView shows all brew parameters organized in sections
- Photo displays in detail view when photoData exists
- Empty state with "No Brews Yet" message shown when list is empty
- Swipe-to-delete removes brew from list
- Photo picker in AddBrewLogView uses EquipmentPhotoPickerView
- MainTabView has 5 tabs: Brews (first), Beans, Methods, Grinders, Settings
- Brews tab wraps BrewLogListView in NavigationStack
- NavigationLink from list row to detail view works
- "+" button in list opens AddBrewLogView as sheet
- BrewLog is included in ModelContainer schema (iCloud sync)
- BrewLog model follows CloudKit safety rules (defaults, optional relationships, external storage)
</verification>

<success_criteria>
Requirements covered: BREW-12 (add photos to brew log), BREW-15 (brew logs sync via iCloud -- verified via CloudKit ModelContainer inclusion and CloudKit-safe model patterns).

Combined with Plans 01 and 02, all BREW-01 through BREW-15 requirements are covered. The complete brew logging vertical slice is functional: create brews with equipment/bean selection, parameters, timer, photos, rating, notes; browse history; view details; sync via iCloud.
</success_criteria>

<output>
After completion, create `.planning/phases/03-brew-logging/03-03-SUMMARY.md`
</output>
