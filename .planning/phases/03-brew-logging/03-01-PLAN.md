---
phase: 03-brew-logging
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - CoffeeJournal/Models/BrewLog.swift
  - CoffeeJournal/ViewModels/BrewLogViewModel.swift
  - CoffeeJournal/Views/Brewing/AddBrewLogView.swift
  - CoffeeJournal/Views/Components/StarRatingView.swift
autonomous: true

must_haves:
  truths:
    - "User can create a new brew log and select a brew method from their equipment"
    - "User can select a grinder and see grind setting constrained to that grinder's range"
    - "User can select a coffee bean from their collection"
    - "User can enter dose, water amount, temperature, and see auto-calculated brew ratio"
    - "User can enter method-specific parameters (yield/pressure for espresso)"
    - "User can manually enter brew time via minutes and seconds steppers"
    - "User can rate overall brew quality 1-5 stars and write freeform notes"
    - "Equipment usage stats (brewCount, lastUsedDate) update on save"
  artifacts:
    - path: "CoffeeJournal/Models/BrewLog.swift"
      provides: "BrewLog model with grinderSetting field and brewRatio computed properties"
      contains: "grinderSetting"
    - path: "CoffeeJournal/ViewModels/BrewLogViewModel.swift"
      provides: "Form state, validation, ratio calculation, grinder setting clamping, save logic"
      exports: ["BrewLogViewModel", "TimerState"]
    - path: "CoffeeJournal/Views/Brewing/AddBrewLogView.swift"
      provides: "Modal form for brew log creation with equipment/bean pickers, parameters, manual brew time entry, rating, notes"
      min_lines: 100
    - path: "CoffeeJournal/Views/Components/StarRatingView.swift"
      provides: "Reusable 1-5 star rating component (monochrome)"
      min_lines: 15
  key_links:
    - from: "CoffeeJournal/Views/Brewing/AddBrewLogView.swift"
      to: "CoffeeJournal/ViewModels/BrewLogViewModel.swift"
      via: "@State private var viewModel = BrewLogViewModel()"
      pattern: "BrewLogViewModel"
    - from: "CoffeeJournal/ViewModels/BrewLogViewModel.swift"
      to: "CoffeeJournal/Models/BrewLog.swift"
      via: "saveBrew creates BrewLog and updates equipment stats"
      pattern: "context\\.insert"
    - from: "CoffeeJournal/Views/Brewing/AddBrewLogView.swift"
      to: "SwiftData @Query"
      via: "Picker sections query BrewMethod, Grinder, CoffeeBean"
      pattern: "@Query"
---

<objective>
Create the brew log entry form with equipment/bean selection, core brewing parameters, auto-calculated ratio, method-specific parameters, manual brew time entry, star rating, and freeform notes.

Purpose: This is the core journaling loop -- the most important feature in the app. Users select their equipment and coffee, enter parameters, and save a brew log. This plan establishes the ViewModel that Plan 02 (timer) and Plan 03 (list/detail) build upon.

Output: BrewLog model updated with grinderSetting, BrewLogViewModel with full form state management, AddBrewLogView modal form, StarRatingView reusable component.
</objective>

<execution_context>
@/Users/ashok/.claude/get-shit-done/workflows/execute-plan.md
@/Users/ashok/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-brew-logging/03-RESEARCH.md
@CoffeeJournal/Models/BrewLog.swift
@CoffeeJournal/Models/BrewMethod.swift
@CoffeeJournal/Models/Grinder.swift
@CoffeeJournal/Models/CoffeeBean.swift
@CoffeeJournal/Models/MethodCategory.swift
@CoffeeJournal/ViewModels/SetupWizardViewModel.swift
@CoffeeJournal/Views/Beans/AddBeanView.swift
@CoffeeJournal/Views/Components/MonochromeStyle.swift
@CoffeeJournal/Views/Components/EmptyStateView.swift
@CoffeeJournal/Views/Equipment/EquipmentPhotoPickerView.swift
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update BrewLog model and create BrewLogViewModel</name>
  <files>CoffeeJournal/Models/BrewLog.swift, CoffeeJournal/ViewModels/BrewLogViewModel.swift</files>
  <action>
**BrewLog.swift** -- Add `grinderSetting` field and computed ratio properties to the existing model:

1. Add `var grinderSetting: Double = 0` after `pressureProfile`. This is safe under CloudKit add-only rules (new field with default, no schema version bump needed).
2. Add computed property `var brewRatio: Double?` that returns `yieldAmount / dose` for espresso methods, or `waterAmount / dose` for all other methods. Returns nil if dose is 0 or divisor is 0.
3. Add computed property `var brewRatioFormatted: String` that returns `String(format: "1:%.1f", ratio)` or "--" if brewRatio is nil.
4. Add computed property `var brewTimeFormatted: String` that formats brewTime (seconds) as "M:SS" (e.g., "3:45").

**BrewLogViewModel.swift** -- Create @Observable ViewModel following SetupWizardViewModel pattern:

1. Define `enum TimerState { case idle, running, paused, stopped }` at top of file.
2. Create `@Observable class BrewLogViewModel` with these property groups:

Equipment selection:
- `var selectedMethod: BrewMethod?`
- `var selectedGrinder: Grinder?`
- `var selectedBean: CoffeeBean?`

Core parameters:
- `var dose: Double = 0` (grams, 0.1g precision)
- `var waterAmount: Double = 0` (grams)
- `var waterTemperature: Double = 0` (degrees)
- `var grinderSetting: Double = 0`

Method-specific (espresso):
- `var yieldAmount: Double = 0`
- `var pressureProfile: String = ""`

Manual brew time entry:
- `var brewTimeMinutes: Int = 0` (0...60, for manual entry Stepper)
- `var brewTimeSeconds: Int = 0` (0...59, for manual entry Stepper)

Rating and notes:
- `var rating: Int = 0` (1-5, 0 = unrated)
- `var notes: String = ""`

Timer state (properties only, timer logic will be extended in Plan 02):
- `var timerState: TimerState = .idle`
- `var timerStartDate: Date?`
- `var pausedElapsed: TimeInterval = 0`
- `var elapsedSeconds: TimeInterval = 0`
- `var brewTime: Double = 0` (final recorded brew time in seconds)

3. Add computed properties:
- `var brewRatio: String` -- Returns "1:X.X" format. For espresso (selectedMethod?.category == .espresso), use yieldAmount/dose. For others, use waterAmount/dose. Return "--" if dose <= 0 or divisor <= 0.
- `var canSave: Bool` -- True when selectedMethod != nil AND dose > 0.
- `var showsYield: Bool` -- True when selectedMethod?.category == .espresso.
- `var showsWaterAmount: Bool` -- True when selectedMethod?.category != .espresso.
- `var showsPressure: Bool` -- True when selectedMethod?.category == .espresso.
- `var showsSteepTime: Bool` -- True when selectedMethod?.category == .immersion.
- `var hasUnsavedChanges: Bool` -- True when any parameter has been set (dose > 0 || selectedMethod != nil || notes.isEmpty == false, etc.).
- `var manualBrewTimeTotal: Double` -- Computed as `Double(brewTimeMinutes * 60 + brewTimeSeconds)`. This converts the manual Stepper values to total seconds.

4. Add `selectedGrinder` observer behavior: When selectedGrinder changes, clamp grinderSetting to the new grinder's settingMin...settingMax range (reset to midpoint: `(grinder.settingMin + grinder.settingMax) / 2`). Implement as `func onGrinderChanged()` called from the view's .onChange modifier.

5. Add `func saveBrew(context: ModelContext)`:
- Create a new BrewLog()
- Set all properties from ViewModel state (brewMethod, grinder, coffeeBean, dose, waterAmount, brewTime, waterTemperature, yieldAmount, pressureProfile, grinderSetting, rating, notes)
- Set brewTime: if timerState == .stopped, use elapsedSeconds; otherwise use manualBrewTimeTotal (the manual Stepper entry)
- context.insert(log)
- Update equipment stats: `method.brewCount += 1; method.lastUsedDate = Date()` and same for grinder
- Update `coffeeBean.lastBrewedDate = Date()` if selectedBean is not nil

Import SwiftData at top of file.
  </action>
  <verify>
Run `swift build` from the project root. BrewLog.swift compiles with grinderSetting field. BrewLogViewModel.swift compiles with all properties, computed values, and saveBrew function. No errors.
  </verify>
  <done>
BrewLog model has grinderSetting field and computed ratio/time formatting. BrewLogViewModel manages full form state with equipment selection, parameter entry, ratio calculation, grinder clamping, manual brew time (minutes + seconds Steppers), validation, and save logic including equipment stat updates.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create StarRatingView and AddBrewLogView form</name>
  <files>CoffeeJournal/Views/Components/StarRatingView.swift, CoffeeJournal/Views/Brewing/AddBrewLogView.swift</files>
  <action>
**StarRatingView.swift** -- Create reusable monochrome star rating component:

1. Accept `@Binding var rating: Int` and `let maxRating: Int = 5`.
2. Render HStack of star SF Symbol buttons: `star.fill` for index <= rating, `star` for unfilled.
3. Use AppColors.primary for filled, AppColors.muted for unfilled.
4. Tap sets rating; tap same star again clears to 0 (toggle behavior: `rating = index == rating ? 0 : index`).
5. Use `.font(.title2)` and `AppSpacing.sm` between stars.

**AddBrewLogView.swift** -- Create the brew log creation form as a modal sheet view:

1. Use `@State private var viewModel = BrewLogViewModel()` at top.
2. Use `@Environment(\.modelContext)` and `@Environment(\.dismiss)`.
3. Structure as a Form with these sections, using @ViewBuilder private computed properties per section (following AddBeanView pattern):

**Section: "Brew Method"** -- Picker with @Query(sort: \BrewMethod.name) methods. Use `.tag(Optional(method))` for optional binding. Include `Text("Select...").tag(nil as BrewMethod?)` placeholder. Show selected method's category icon next to name.

**Section: "Coffee"** -- Picker with @Query for active (non-archived) CoffeeBean sorted by createdAt descending. Use `.tag(Optional(bean))` for optional binding. Show bean's displayName.

**Section: "Grinder"** -- Picker with @Query(sort: \Grinder.name) grinders. Use `.tag(Optional(grinder))` for optional binding. Conditionally show grind setting Slider below the Picker when a grinder is selected: `Slider(value: $viewModel.grinderSetting, in: grinder.settingMin...grinder.settingMax, step: grinder.settingStep)` with min/max labels and current value display (`Text("Setting: X.X")`). Add `.onChange(of: viewModel.selectedGrinder)` that calls `viewModel.onGrinderChanged()`.

**Section: "Brew Parameters"** -- Always show dose TextField with .keyboardType(.decimalPad). Conditionally show:
- Water amount (when showsWaterAmount is true)
- Yield (when showsYield is true)
- Temperature (always except pour-over -- show for espresso, immersion, other)
- Pressure profile TextField (when showsPressure is true)
Each parameter as HStack { Text(label), Spacer(), TextField(placeholder, value:format:) } with `.frame(width: 80)` on the TextField and `.multilineTextAlignment(.trailing)`.

**Section: "Brew Ratio" (read-only display)** -- Show `viewModel.brewRatio` in a prominent Text with `.font(AppTypography.title)`. Update live as dose/water/yield changes.

**Section: "Brew Time" (manual entry -- Plan 02 will replace this section with the integrated timer)** -- Create two Steppers for manual brew time entry:
- Minutes Stepper: `Stepper("Minutes: \(viewModel.brewTimeMinutes)", value: $viewModel.brewTimeMinutes, in: 0...60)`
- Seconds Stepper: `Stepper("Seconds: \(viewModel.brewTimeSeconds)", value: $viewModel.brewTimeSeconds, in: 0...59)`
- Below the Steppers, show total time formatted as "M:SS" read-only text (e.g., "Total: 3:45")
This explicit manual entry section will be replaced by BrewTimerView in Plan 03-02, which adds start/pause/stop timer controls with a manual fallback.

**Section: "Rating & Notes"** -- StarRatingView(rating: $viewModel.rating). Below it, TextField("Tasting notes (optional)", text: $viewModel.notes, axis: .vertical) with .lineLimit(3...6).

4. Add `.navigationTitle("Log Brew")` and toolbar Cancel/Save buttons following AddBeanView pattern exactly (Cancel left, Save right with .fontWeight(.semibold), .foregroundStyle(AppColors.primary), .disabled(!viewModel.canSave)).

5. Add `.interactiveDismissDisabled(viewModel.hasUnsavedChanges)` to prevent accidental dismissal.

6. Add `.scrollDismissesKeyboard(.interactively)` on the Form for keyboard handling.

7. Save action: call `viewModel.saveBrew(context: modelContext)` then `dismiss()`.

IMPORTANT: Do NOT nest a NavigationStack inside this view. The presenting view (Plan 03's BrewLogListView) wraps the sheet in NavigationStack. Follow AddBeanView convention.

Note: The @Query properties for methods, grinders, and beans should be declared at the top of AddBrewLogView (or in small child section views that hold the @Query). If using child views per picker section, pass `@Bindable var viewModel: BrewLogViewModel` to them.
  </action>
  <verify>
Run `swift build` from the project root. Both files compile without errors. StarRatingView exists with @Binding rating. AddBrewLogView has Form with all sections including "Brew Time" section with minutes/seconds Steppers, toolbar Save/Cancel, and uses BrewLogViewModel.
  </verify>
  <done>
AddBrewLogView presents a multi-section Form for brew log creation. User can select brew method, coffee bean, grinder with constrained grind setting slider, enter dose/water/temperature/yield parameters with method-adaptive visibility, manually enter brew time via minutes and seconds Steppers, see auto-calculated brew ratio, rate 1-5 stars, write freeform notes, and save. Equipment stats update on save. Form prevents accidental dismissal when data has been entered. The "Brew Time" section with manual Steppers is a concrete target for Plan 03-02 to replace with the integrated timer.
  </done>
</task>

</tasks>

<verification>
- `swift build` passes with no errors
- BrewLog model contains grinderSetting field with default value 0
- BrewLogViewModel has all computed properties (brewRatio, canSave, shows* flags, manualBrewTimeTotal)
- BrewLogViewModel has brewTimeMinutes and brewTimeSeconds properties for manual entry
- AddBrewLogView renders Form with method/coffee/grinder pickers, parameter inputs, ratio display, manual brew time Steppers, rating, notes
- StarRatingView renders tappable monochrome stars
- Grind setting slider is constrained to selected grinder's range
- Ratio updates live when dose/water/yield changes
- Manual brew time Steppers allow setting minutes (0-60) and seconds (0-59)
- Save button disabled when method not selected or dose is 0
</verification>

<success_criteria>
Requirements covered: BREW-01 (create brew log), BREW-02 (select grinder + setting), BREW-03 (select method), BREW-04 (select coffee), BREW-05 (dose input), BREW-06 (water amount), BREW-07 (auto ratio), BREW-09 (temperature), BREW-10 (method-specific: yield/pressure), BREW-13 (rating 1-5), BREW-14 (freeform notes).

The form is fully functional for creating brew logs with manual brew time entry. Timer (BREW-08, BREW-11), photos (BREW-12), list/detail views, and tab wiring are in Plans 02 and 03.
</success_criteria>

<output>
After completion, create `.planning/phases/03-brew-logging/03-01-SUMMARY.md`
</output>
