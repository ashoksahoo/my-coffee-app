---
phase: 05-history-search
plan: 02
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - CoffeeJournal/Views/History/StatisticsDashboardView.swift
  - CoffeeJournal/Views/Brewing/BrewLogListView.swift
  - Package.swift
autonomous: true

must_haves:
  truths:
    - "User can navigate to a statistics dashboard from the Brews tab toolbar"
    - "User sees summary stat cards: total brews, average rating, top method, top bean"
    - "User sees a bar chart of brews by method (method distribution)"
    - "User sees a line chart of average rating over time (rating trend)"
    - "User sees a bar chart of brew frequency by month"
    - "User sees an appropriate empty state when no brews exist"
    - "Charts use monochrome grayscale styling consistent with app design system"
  artifacts:
    - path: "CoffeeJournal/Views/History/StatisticsDashboardView.swift"
      provides: "Statistics dashboard with summary cards and Swift Charts (BarMark, LineMark, SectorMark)"
      contains: "import Charts"
    - path: "CoffeeJournal/Views/Brewing/BrewLogListView.swift"
      provides: "Toolbar button navigating to StatisticsDashboardView"
      contains: "StatisticsDashboardView"
  key_links:
    - from: "BrewLogListView.swift"
      to: "StatisticsDashboardView.swift"
      via: "NavigationLink in toolbar with chart.bar.xaxis icon"
      pattern: "StatisticsDashboardView"
    - from: "StatisticsDashboardView.swift"
      to: "BrewLog"
      via: "@Query fetching all brews for aggregation"
      pattern: "@Query.*BrewLog"
---

<objective>
Build the statistics dashboard with Swift Charts showing favorite methods, top beans, average ratings, and trends over time. Wire navigation from the Brews tab toolbar. This delivers HIST-06 (statistics dashboard).

Purpose: Give users insight into their brewing patterns through visual charts and summary statistics, completing the Phase 5 analytics capability.

Output: StatisticsDashboardView with summary cards + 4 charts, toolbar navigation from BrewLogListView.
</objective>

<execution_context>
@/Users/ashok/.claude/get-shit-done/workflows/execute-plan.md
@/Users/ashok/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-history-search/05-01-SUMMARY.md
@CoffeeJournal/Views/Brewing/BrewLogListView.swift
@CoffeeJournal/Models/BrewLog.swift
@CoffeeJournal/Views/Components/MonochromeStyle.swift
@CoffeeJournal/Views/Brewing/BrewLogRow.swift
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create StatisticsDashboardView with summary cards and charts</name>
  <files>
    CoffeeJournal/Views/History/StatisticsDashboardView.swift
  </files>
  <action>
Create `StatisticsDashboardView.swift` in `CoffeeJournal/Views/History/`.

1. Import SwiftUI, SwiftData, and Charts.

2. Create `struct StatisticsDashboardView: View` with:
   - `@Query(sort: \BrewLog.createdAt, order: .reverse) private var brews: [BrewLog]`

3. **Body structure:** `ScrollView` containing `VStack(alignment: .leading, spacing: AppSpacing.lg)`:
   - If `brews.isEmpty`, show `EmptyStateView(systemImage: "chart.bar", title: "No Statistics Yet", message: "Log some brews to see your stats")`.
   - Otherwise, show: `summaryCards`, `methodDistributionChart`, `ratingTrendChart`, `brewFrequencyChart`, `topBeansChart`.
   - Apply `.padding(AppSpacing.md)` to the VStack.

4. Add `.navigationTitle("Statistics")` and `.navigationBarTitleDisplayMode(.inline)`.

5. **Summary Cards (`summaryCards`):**
   - Use `LazyVGrid(columns: [GridItem(.flexible()), GridItem(.flexible())], spacing: AppSpacing.md)`.
   - Four StatCard items:
     - "Total Brews": `"\(brews.count)"`, icon: `"mug"`
     - "Avg Rating": computed average of brews with rating > 0, formatted as "X.X", or "--" if no rated brews. Icon: `"star"`
     - "Top Method": most frequent `brewMethod?.name`, or "--" if none. Icon: `"cup.and.saucer"`
     - "Top Bean": most frequent `coffeeBean?.displayName`, or "--" if none. Icon: `"leaf"`

6. **StatCard (private struct):**
   ```swift
   private struct StatCard: View {
       let title: String
       let value: String
       let icon: String
       var body: some View {
           VStack(spacing: AppSpacing.xs) {
               Image(systemName: icon)
                   .font(AppTypography.title)
                   .foregroundStyle(AppColors.subtle)
               Text(value)
                   .font(AppTypography.headline)
                   .lineLimit(1)
                   .minimumScaleFactor(0.7)
               Text(title)
                   .font(AppTypography.caption)
                   .foregroundStyle(AppColors.secondary)
           }
           .frame(maxWidth: .infinity)
           .padding(AppSpacing.md)
           .background(AppColors.secondaryBackground)
           .clipShape(RoundedRectangle(cornerRadius: 8))
       }
   }
   ```

7. **Method Distribution Chart (`methodDistributionChart`):**
   - Section title: "Brews by Method" using `AppTypography.headline`.
   - Compute method counts: `Dictionary(grouping: brews, by: { $0.brewMethod?.name ?? "Unknown" }).mapValues { $0.count }.sorted { $0.value > $1.value }`.
   - Use `Chart` with `BarMark(x: .value("Method", item.key), y: .value("Count", item.value))`.
   - Apply `.foregroundStyle(AppColors.primary.opacity(0.8))`.
   - Chart frame height: 200.
   - Wrap in a VStack with alignment .leading, spacing AppSpacing.sm.

8. **Rating Trend Chart (`ratingTrendChart`):**
   - Section title: "Rating Trend" using `AppTypography.headline`.
   - Filter to rated brews: `brews.filter { $0.rating > 0 }`.
   - Only show section if there are rated brews.
   - Group by month using Calendar: `Dictionary(grouping: ratedBrews) { Calendar.current.dateInterval(of: .month, for: $0.createdAt)?.start ?? $0.createdAt }`.
   - Compute monthly average rating for each group.
   - Create a simple data struct: `private struct MonthlyRating: Identifiable { let id = UUID(); let month: Date; let averageRating: Double }`.
   - Use `Chart` with `LineMark(x: .value("Month", item.month, unit: .month), y: .value("Rating", item.averageRating))`.
   - Add `PointMark` at same coordinates for data point visibility.
   - Apply `.foregroundStyle(AppColors.primary)`.
   - Set y-axis scale: `.chartYScale(domain: 0...5)`.
   - Chart frame height: 200.

9. **Brew Frequency Chart (`brewFrequencyChart`):**
   - Section title: "Brew Frequency" using `AppTypography.headline`.
   - Use `Chart(brews) { BarMark(x: .value("Month", $0.createdAt, unit: .month), y: .value("Count", 1)) }`.
   - Apply `.foregroundStyle(AppColors.primary.opacity(0.8))`.
   - Add `.chartXAxis` with `AxisMarks(values: .stride(by: .month))` and `AxisValueLabel(format: .dateTime.month(.abbreviated))`.
   - Chart frame height: 200.

10. **Top Beans Chart (`topBeansChart`):**
    - Section title: "Top Beans" using `AppTypography.headline`.
    - Compute bean counts: `Dictionary(grouping: brews, by: { $0.coffeeBean?.displayName ?? "Unknown" }).mapValues { $0.count }.sorted { $0.value > $1.value }.prefix(5)`.
    - Only show section if there are brews with beans.
    - Use `Chart` with `BarMark(x: .value("Count", item.value), y: .value("Bean", item.key))` -- horizontal bars for potentially long bean names.
    - Apply `.foregroundStyle(AppColors.primary.opacity(0.8))`.
    - Chart frame height: `max(120, CGFloat(beanCounts.count) * 40)` -- adaptive height.

**Computed helper properties:**
- `private var averageRatingFormatted: String` -- computes average of rated brews.
- `private var topMethodName: String` -- most frequent method name.
- `private var topBeanName: String` -- most frequent bean displayName.

**Design constraints:**
- All charts use monochrome grayscale: `AppColors.primary` with varying opacity (0.8 for bars, 1.0 for lines).
- No colorful chart palettes. Use `Color.primary.opacity()` variations only.
- Section headers use `AppTypography.headline`.
- Follow the existing monochrome design system throughout.
  </action>
  <verify>
Build succeeds (note: `swift build` may fail on Charts import since it's a system framework -- verify with Xcode build or check that the Swift file has correct syntax by examining for compilation errors in non-Charts code). StatisticsDashboardView has 4 chart sections and summary cards. All charts use monochrome styling.
  </verify>
  <done>
StatisticsDashboardView displays summary cards (total brews, avg rating, top method, top bean) and 4 charts (method distribution bar chart, rating trend line chart, brew frequency bar chart, top beans horizontal bar chart). All charts use monochrome grayscale styling. Empty state shown when no brews exist.
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire statistics navigation from BrewLogListView toolbar and update Package.swift</name>
  <files>
    CoffeeJournal/Views/Brewing/BrewLogListView.swift
    Package.swift
  </files>
  <action>
**BrewLogListView.swift -- Add statistics toolbar button:**

1. Add a `NavigationLink` to `StatisticsDashboardView()` in the toolbar. Place it as a `ToolbarItem(placement: .topBarLeading)` alongside the existing Compare button. Use an `HStack` or two separate `ToolbarItem`s in the leading position:
   - Keep existing Compare button: `NavigationLink { BrewComparisonView() } label: { Image(systemName: "arrow.left.arrow.right") }`
   - Add Statistics button: `NavigationLink { StatisticsDashboardView() } label: { Image(systemName: "chart.bar.xaxis") }` with `.foregroundStyle(AppColors.primary)`.

   Alternatively, group both in a single `ToolbarItemGroup(placement: .topBarLeading)`:
   ```swift
   ToolbarItemGroup(placement: .topBarLeading) {
       NavigationLink {
           BrewComparisonView()
       } label: {
           Image(systemName: "arrow.left.arrow.right")
               .foregroundStyle(AppColors.primary)
       }
       NavigationLink {
           StatisticsDashboardView()
       } label: {
           Image(systemName: "chart.bar.xaxis")
               .foregroundStyle(AppColors.primary)
       }
   }
   ```

2. This follows the established pattern from Phase 4 where BrewComparisonView was wired via toolbar NavigationLink.

**Package.swift -- Add StatisticsDashboardView:**

1. Add `"Views/History/StatisticsDashboardView.swift"` to the sources array, after the other History view entries.

2. **Important note about Charts import:** The `Charts` framework is a system framework. In SPM CLI builds (macOS target), `import Charts` should resolve since Charts is available on macOS 14+. If the CLI build fails specifically on the Charts import, the executor should wrap the Charts import and chart code with `#if canImport(Charts)` / `#endif` to allow the non-chart code to still compile. However, try without the conditional first -- it should work since the Package.swift targets macOS 14+.
  </action>
  <verify>
`swift build` succeeds (or if Charts import fails on CLI, the `#if canImport(Charts)` fallback is in place). BrewLogListView toolbar has both Compare and Statistics navigation buttons. Tapping Statistics navigates to StatisticsDashboardView.
  </verify>
  <done>
BrewLogListView toolbar has a statistics button (chart.bar.xaxis icon) that navigates to StatisticsDashboardView via NavigationLink. Package.swift includes the new file. The Brews tab toolbar now has: Compare + Statistics (leading), Filter + Add (trailing).
  </done>
</task>

</tasks>

<verification>
1. StatisticsDashboardView compiles with Charts import and displays 4 chart types
2. Summary cards show total brews, average rating, top method, top bean
3. Method distribution bar chart renders with monochrome bars
4. Rating trend line chart renders with data points
5. Brew frequency chart shows monthly brewing activity
6. Top beans chart shows horizontal bars for top 5 beans
7. Empty state shown when no brews exist
8. Navigation from BrewLogListView toolbar to StatisticsDashboardView works
9. All charts use AppColors.primary with opacity variations (no color)
</verification>

<success_criteria>
- Statistics dashboard accessible from Brews tab toolbar via chart icon
- Summary cards display correctly computed statistics
- Bar chart shows brews grouped by method
- Line chart shows average rating trend over time (by month)
- Bar chart shows brew frequency over time (by month)
- Horizontal bar chart shows top 5 beans by brew count
- Empty state displayed when no brews logged yet
- All visualizations use monochrome grayscale styling matching app design
</success_criteria>

<output>
After completion, create `.planning/phases/05-history-search/05-02-SUMMARY.md`
</output>
