---
phase: 09-automated-qa-suite
plan: 03
type: execute
wave: 2
depends_on: ["09-01"]
files_modified:
  - CoffeeJournalTests/Models/BrewLogComputedTests.swift
  - CoffeeJournalTests/Models/CoffeeBeanComputedTests.swift
  - CoffeeJournalTests/Integration/SwiftDataPersistenceTests.swift
  - .github/workflows/tests.yml
autonomous: true

must_haves:
  truths:
    - "SwiftData models can be created, read, updated, and deleted in in-memory container"
    - "Model computed properties (brewRatio, displayName) return correct values with real @Model instances"
    - "Model relationships (BrewLog -> BrewMethod, BrewLog -> TastingNote) are correctly established"
    - "CI/CD pipeline runs tests automatically on push and PR"
  artifacts:
    - path: "CoffeeJournalTests/Models/BrewLogComputedTests.swift"
      provides: "Integration tests for BrewLog computed properties with real @Model instances"
      contains: "XCTestCase"
    - path: "CoffeeJournalTests/Models/CoffeeBeanComputedTests.swift"
      provides: "Integration tests for CoffeeBean computed properties"
      contains: "XCTestCase"
    - path: "CoffeeJournalTests/Integration/SwiftDataPersistenceTests.swift"
      provides: "CRUD and relationship tests for SwiftData models"
      contains: "ModelContainer"
    - path: ".github/workflows/tests.yml"
      provides: "GitHub Actions CI pipeline for automated test runs"
      contains: "xcodebuild test"
  key_links:
    - from: "CoffeeJournalTests/Integration/SwiftDataPersistenceTests.swift"
      to: "SwiftData ModelContainer"
      via: "in-memory configuration"
      pattern: "isStoredInMemoryOnly: true"
    - from: ".github/workflows/tests.yml"
      to: "xcodebuild"
      via: "test command"
      pattern: "xcodebuild test"
---

<objective>
Create SwiftData integration tests and GitHub Actions CI/CD pipeline.

Purpose: Covers TEST-04 (SwiftData persistence validation with in-memory ModelContainer) and TEST-05 (CI/CD pipeline). Integration tests verify model CRUD, computed properties on @Model classes, and relationships -- things that cannot be tested without a real SwiftData context.

Output: 3 integration test files testing BrewLog/CoffeeBean computed properties and SwiftData persistence CRUD. GitHub Actions workflow running full test suite on push/PR.
</objective>

<execution_context>
@/Users/ashok/.claude/get-shit-done/workflows/execute-plan.md
@/Users/ashok/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-automated-qa-suite/09-RESEARCH.md
@.planning/phases/09-automated-qa-suite/09-01-SUMMARY.md
@CoffeeJournal/Models/BrewLog.swift
@CoffeeJournal/Models/CoffeeBean.swift
@CoffeeJournal/Models/BrewMethod.swift
@CoffeeJournal/Models/Grinder.swift
@CoffeeJournal/Models/TastingNote.swift
@CoffeeJournal/Models/Schema/SchemaV1.swift
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create SwiftData integration tests</name>
  <files>
    CoffeeJournalTests/Models/BrewLogComputedTests.swift
    CoffeeJournalTests/Models/CoffeeBeanComputedTests.swift
    CoffeeJournalTests/Integration/SwiftDataPersistenceTests.swift
  </files>
  <action>
    Create integration tests using XCTest (NOT Swift Testing) because SwiftData @MainActor requirements work more reliably with XCTestCase. All tests use in-memory ModelContainer for isolation.

    **IMPORTANT:** Each test class must be marked `@MainActor` to satisfy SwiftData's mainContext isolation requirement. Each class creates its own container in `setUpWithError()` and nils it in `tearDownWithError()`.

    **Common setUp pattern for all integration tests:**
    ```swift
    @MainActor
    final class XxxTests: XCTestCase {
        var container: ModelContainer!

        override func setUpWithError() throws {
            let config = ModelConfiguration(isStoredInMemoryOnly: true)
            container = try ModelContainer(
                for: BrewMethod.self, Grinder.self, CoffeeBean.self, BrewLog.self, TastingNote.self,
                configurations: config
            )
        }

        override func tearDownWithError() throws {
            container = nil
        }
    }
    ```

    1. **BrewLogComputedTests.swift** - Test BrewLog computed properties with real @Model:
       - `testBrewRatioNonEspresso()`: Create BrewMethod(name: "V60", category: .pourOver), insert. Create BrewLog with dose=15, waterAmount=250, set brewMethod. Assert `brewRatio` equals 250/15 (accuracy 0.01). Assert `brewRatioFormatted` equals "1:16.7".
       - `testBrewRatioEspresso()`: Create BrewMethod(name: "Espresso", category: .espresso), insert. Create BrewLog with dose=18, yieldAmount=36, set brewMethod. Assert `brewRatio` equals 2.0. Assert `brewRatioFormatted` equals "1:2.0".
       - `testBrewRatioZeroDose()`: Create BrewLog with dose=0. Assert `brewRatio` is nil. Assert `brewRatioFormatted` equals "--".
       - `testBrewRatioNoWater()`: Create BrewLog with dose=15, waterAmount=0, no method. Assert `brewRatio` is nil.
       - `testBrewTimeFormatted()`: Create BrewLog with brewTime=185 (3:05). Assert `brewTimeFormatted` equals "3:05".
       - `testBrewTimeFormattedZero()`: Create BrewLog with brewTime=0. Assert `brewTimeFormatted` equals "0:00".

    2. **CoffeeBeanComputedTests.swift** - Test CoffeeBean computed properties with real @Model:
       - `testDisplayNameWithName()`: Create CoffeeBean with name="Kenya AA". Assert `displayName` equals "Kenya AA".
       - `testDisplayNameFallbackRoasterOrigin()`: Create CoffeeBean with name="" (default), roaster="Blue Bottle", origin="Ethiopia". Assert `displayName` equals "Blue Bottle - Ethiopia".
       - `testDisplayNameFallbackRoasterOnly()`: roaster="Blue Bottle", origin="". Assert `displayName` equals "Blue Bottle".
       - `testDisplayNameFallbackOriginOnly()`: roaster="", origin="Ethiopia". Assert `displayName` equals "Ethiopia".
       - `testDisplayNameUnnamed()`: All fields empty. Assert `displayName` equals "Unnamed Coffee".
       - `testRoastLevelEnum()`: Create CoffeeBean, set roastLevel="light". Assert `roastLevelEnum` equals .light. Set roastLevelEnum = .dark, assert roastLevel == "dark".
       - `testProcessingMethodEnum()`: Create CoffeeBean, set processingMethod="washed". Assert `processingMethodEnum` equals .washed.
       - `testFreshnessLevel()`: Create CoffeeBean with roastDate = 7 days ago. Assert `freshnessLevel` equals .peak. Set roastDate = 20 days ago. Assert `freshnessLevel` equals .acceptable.
       - `testFreshnessLevelNoDate()`: Create CoffeeBean with no roastDate. Assert `freshnessLevel` is nil.

    3. **SwiftDataPersistenceTests.swift** - Test CRUD operations and relationships:
       - `testCreateAndFetchBrewMethod()`: Insert BrewMethod(name: "V60", category: .pourOver), fetch all BrewMethods, assert count == 1 and name == "V60".
       - `testCreateAndFetchGrinder()`: Insert Grinder(name: "Comandante", type: .hand), fetch, assert name.
       - `testCreateAndFetchCoffeeBean()`: Insert CoffeeBean, set roaster/origin, fetch, assert values.
       - `testCreateBrewLogWithRelationships()`: Create method, grinder, bean, insert all. Create BrewLog, set brewMethod/grinder/coffeeBean, insert. Fetch BrewLog, assert all relationships non-nil and point to correct objects.
       - `testDeleteBrewMethod()`: Insert 2 methods, delete 1, fetch, assert count == 1.
       - `testBrewLogTastingNoteRelationship()`: Create BrewLog, insert. Create TastingNote, set brewLog relationship, insert. Fetch BrewLog, assert `tastingNote` is non-nil. Assert `tastingNote.brewLog` points back.
       - `testUpdateBrewMethod()`: Insert method, change name, fetch, assert new name.
       - `testMultipleBrewLogsPerMethod()`: Create 1 method, create 3 BrewLogs all pointing to that method, insert all. Fetch method. Verify method.brewCount can be incremented (set to 3, assert equals 3).

    All integration tests use `XCTAssertEqual`, `XCTAssertNotNil`, `XCTAssertNil`, `XCTAssertTrue` from XCTest.
    All use `container.mainContext` for operations.
    All inserts call `context.insert(object)` then optionally `try context.save()`.
  </action>
  <verify>
    - All 3 integration test files exist under CoffeeJournalTests/
    - `grep -r "ModelContainer" CoffeeJournalTests/Integration/` shows in-memory container usage
    - `grep -r "isStoredInMemoryOnly" CoffeeJournalTests/` shows test isolation pattern
    - `grep -r "@MainActor" CoffeeJournalTests/Models/` shows MainActor annotation
    - `grep -r "XCTestCase" CoffeeJournalTests/Models/ CoffeeJournalTests/Integration/` shows XCTest usage
    - Each file has at least 4 test methods
  </verify>
  <done>
    3 integration test files exist: BrewLogComputedTests (6 tests for ratio/time), CoffeeBeanComputedTests (9 tests for displayName/enums/freshness), SwiftDataPersistenceTests (8 tests for CRUD and relationships). All use @MainActor + in-memory ModelContainer for test isolation.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create GitHub Actions CI/CD workflow</name>
  <files>
    .github/workflows/tests.yml
  </files>
  <action>
    Create GitHub Actions workflow file at `.github/workflows/tests.yml`:

    ```yaml
    name: Tests

    on:
      push:
        branches: [master, main]
      pull_request:
        branches: [master, main]

    jobs:
      unit-tests:
        name: Unit & Integration Tests
        runs-on: macos-14
        steps:
          - uses: actions/checkout@v4

          - name: Select Xcode
            run: sudo xcode-select -s /Applications/Xcode_16.0.app/Contents/Developer

          - name: Show Xcode version
            run: xcodebuild -version

          - name: List available simulators
            run: xcrun simctl list devices available | head -30

          - name: Run Unit & Integration Tests
            run: |
              xcodebuild test \
                -project CoffeeJournal.xcodeproj \
                -scheme CoffeeJournal \
                -destination 'platform=iOS Simulator,name=iPhone 16,OS=latest' \
                -only-testing:CoffeeJournalTests \
                CODE_SIGNING_ALLOWED='NO' \
                -parallel-testing-enabled NO \
                -resultBundlePath TestResults/unit-tests.xcresult

          - name: Upload Unit Test Results
            uses: actions/upload-artifact@v4
            if: always()
            with:
              name: unit-test-results
              path: TestResults/unit-tests.xcresult

      ui-tests:
        name: UI Tests
        runs-on: macos-14
        steps:
          - uses: actions/checkout@v4

          - name: Select Xcode
            run: sudo xcode-select -s /Applications/Xcode_16.0.app/Contents/Developer

          - name: Run UI Tests
            run: |
              xcodebuild test \
                -project CoffeeJournal.xcodeproj \
                -scheme CoffeeJournal \
                -destination 'platform=iOS Simulator,name=iPhone 16,OS=latest' \
                -only-testing:CoffeeJournalUITests \
                CODE_SIGNING_ALLOWED='NO' \
                -parallel-testing-enabled NO \
                -resultBundlePath TestResults/ui-tests.xcresult

          - name: Upload UI Test Results
            uses: actions/upload-artifact@v4
            if: always()
            with:
              name: ui-test-results
              path: TestResults/ui-tests.xcresult
    ```

    Key configuration decisions:
    - `macos-14` runner: Stable, ships with Xcode 16.x, avoids macOS-15 parallel testing bugs (research pitfall 6)
    - `CODE_SIGNING_ALLOWED='NO'`: Prevents code signing errors in CI (no provisioning profiles)
    - `-parallel-testing-enabled NO`: Avoids flaky UI test issues from parallel execution
    - `-only-testing`: Splits unit and UI tests into separate jobs for clearer pass/fail signals
    - `actions/upload-artifact@v4`: Preserves .xcresult bundles for debugging failed CI runs
    - Unit and UI tests run as separate parallel jobs for faster CI turnaround
    - `if: always()` on upload step ensures results are captured even on test failure

    Also create the `.github/workflows/` directory if it does not exist.
  </action>
  <verify>
    - `ls .github/workflows/tests.yml` confirms workflow file exists
    - `grep "xcodebuild test" .github/workflows/tests.yml` shows test commands
    - `grep "CODE_SIGNING_ALLOWED" .github/workflows/tests.yml` shows code signing disabled
    - `grep "macos-14" .github/workflows/tests.yml` shows correct runner
    - `grep "parallel-testing-enabled NO" .github/workflows/tests.yml` shows parallel testing disabled
    - `grep "only-testing:CoffeeJournalTests" .github/workflows/tests.yml` shows unit test targeting
    - `grep "only-testing:CoffeeJournalUITests" .github/workflows/tests.yml` shows UI test targeting
  </verify>
  <done>
    GitHub Actions workflow at .github/workflows/tests.yml runs unit tests and UI tests as separate parallel jobs on push/PR to master/main. Uses macos-14 runner with Xcode 16, disabled code signing, disabled parallel testing, and uploads .xcresult artifacts for debugging.
  </done>
</task>

</tasks>

<verification>
- 3 integration test files under CoffeeJournalTests/ covering model computed properties and SwiftData CRUD
- All integration tests use @MainActor + in-memory ModelContainer
- GitHub Actions workflow exists at .github/workflows/tests.yml
- CI workflow runs unit + integration tests and UI tests in separate jobs
- CI workflow uses proper Xcode/simulator configuration and artifact upload
</verification>

<success_criteria>
- TEST-04 satisfied: Integration tests validate SwiftData persistence with in-memory ModelContainer for BrewLog, CoffeeBean, BrewMethod, Grinder, TastingNote CRUD and relationships
- TEST-05 satisfied: GitHub Actions CI/CD pipeline runs full test suite on push/PR with clear pass/fail (separate unit and UI test jobs)
- All integration tests use test isolation (in-memory container per test)
</success_criteria>

<output>
After completion, create `.planning/phases/09-automated-qa-suite/09-03-SUMMARY.md`
</output>
