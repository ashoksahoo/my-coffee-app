---
phase: 08-data-export
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - CoffeeJournal/Services/Export/PDFExporter.swift
  - CoffeeJournal/Services/Export/CSVExporter.swift
  - CoffeeJournal/Services/Export/ExportTypes.swift
  - CoffeeJournal/Views/Brewing/BrewLogListView.swift
  - Package.swift
autonomous: true

must_haves:
  truths:
    - "User can export a collection of brew logs as a formatted PDF journal"
    - "User can export brew data as a CSV file for spreadsheet analysis"
    - "Exports operate on the currently filtered/displayed brew list"
  artifacts:
    - path: "CoffeeJournal/Services/Export/PDFExporter.swift"
      provides: "Multi-page PDF journal generation with UIGraphicsPDFRenderer"
      contains: "UIGraphicsPDFRenderer"
    - path: "CoffeeJournal/Services/Export/CSVExporter.swift"
      provides: "CSV string generation with proper field escaping"
      contains: "escapeCSVField"
    - path: "CoffeeJournal/Services/Export/ExportTypes.swift"
      provides: "Transferable wrappers (ExportedPDF, ExportedCSV) with FileRepresentation"
      contains: "FileRepresentation"
    - path: "CoffeeJournal/Views/Brewing/BrewLogListView.swift"
      provides: "Export menu in toolbar with PDF and CSV options"
      contains: "Export"
  key_links:
    - from: "CoffeeJournal/Views/Brewing/BrewLogListView.swift"
      to: "CoffeeJournal/Services/Export/PDFExporter.swift"
      via: "PDFExporter.generateJournal call in export action"
      pattern: "PDFExporter\\.generateJournal"
    - from: "CoffeeJournal/Views/Brewing/BrewLogListView.swift"
      to: "CoffeeJournal/Services/Export/CSVExporter.swift"
      via: "CSVExporter.generateCSV call in export action"
      pattern: "CSVExporter\\.generateCSV"
    - from: "CoffeeJournal/Services/Export/ExportTypes.swift"
      to: "ShareLink"
      via: "Transferable conformance for ShareLink consumption"
      pattern: "Transferable"
---

<objective>
Create PDF and CSV export services and wire them into the BrewLogListView toolbar as an export menu.

Purpose: Enables users to export their filtered brew history as a formatted PDF journal (for sharing/printing) or CSV file (for spreadsheet analysis), satisfying HIST-07 and HIST-08.
Output: PDFExporter, CSVExporter, Transferable wrappers, and export Menu in BrewLogListView toolbar.
</objective>

<execution_context>
@/Users/ashok/.claude/get-shit-done/workflows/execute-plan.md
@/Users/ashok/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@.planning/phases/05-history-search/05-01-SUMMARY.md
@CoffeeJournal/Models/BrewLog.swift
@CoffeeJournal/Models/TastingNote.swift
@CoffeeJournal/Models/CoffeeBean.swift
@CoffeeJournal/Models/BrewMethod.swift
@CoffeeJournal/Models/Grinder.swift
@CoffeeJournal/Views/Brewing/BrewLogListView.swift
@CoffeeJournal/Views/History/BrewHistoryListContent.swift
@CoffeeJournal/Views/Tasting/FlavorWheel.swift
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create PDFExporter, CSVExporter, and Transferable wrapper types</name>
  <files>
    CoffeeJournal/Services/Export/PDFExporter.swift
    CoffeeJournal/Services/Export/CSVExporter.swift
    CoffeeJournal/Services/Export/ExportTypes.swift
  </files>
  <action>
Create the `Services/Export/` directory with three files:

**PDFExporter.swift** -- A struct with a `@MainActor static func generateJournal(brews: [BrewLog], title: String = "Coffee Journal") -> URL?` method:
- Use `UIGraphicsPDFRenderer` with US Letter page size (612x792 points).
- Set 50pt margins for content rect.
- Draw a title page with the journal title (centered, large font), brew count, and export date using `NSAttributedString.draw(in:)`.
- For each brew, draw an entry with: date (section header), method name + coffee name (subtitle), parameters (dose, water/yield, time, temp, ratio) as a compact parameter grid, grinder + setting if present, rating as star characters, notes text (truncated to first 200 chars if very long), and tasting note attributes (acidity/body/sweetness) if present.
- Track vertical offset (`yOffset`). Before drawing each entry, estimate its height. If the entry would exceed the content rect bottom, call `context.beginPage()` and reset yOffset to content top.
- Use monochrome styling: black text, gray secondary text, thin separator lines between entries.
- Write the PDF `Data` to `FileManager.default.temporaryDirectory.appendingPathComponent("CoffeeJournal.pdf")`.
- Return the URL on success, nil on failure.
- Font choices: title = `.boldSystemFont(ofSize: 24)`, section header = `.boldSystemFont(ofSize: 14)`, body = `.systemFont(ofSize: 11)`, caption = `.systemFont(ofSize: 9)` with gray color.

**CSVExporter.swift** -- A struct with a `static func generateCSV(brews: [BrewLog]) -> URL?` method:
- Build a CSV string with header row: `Date,Method,Coffee,Dose (g),Water (g),Yield (g),Temperature (C),Brew Time,Ratio,Grinder,Grind Setting,Rating,Notes,Acidity,Body,Sweetness,Flavors`
- For each brew, build one row with all fields. Use `DateFormatter` with `.medium` date style and `.short` time style for the date.
- Get coffee display name from `brew.coffeeBean?.displayName ?? ""`.
- Get method name from `brew.brewMethod?.name ?? ""`.
- Get grinder from `brew.grinder?.name ?? ""`.
- For tasting note attributes, use `brew.tastingNote?.acidity` etc., defaulting to empty string if nil.
- For flavor tags: decode the JSON string from `tastingNote.flavorTags`, resolve SCA node IDs via `FlavorWheel.findNode(byId:)?.name`, strip "custom:" prefix for custom tags, join with "; " (semicolons to avoid CSV comma conflicts).
- Implement `private static func escapeCSVField(_ field: String) -> String` -- if the field contains comma, double-quote, or newline, wrap in double quotes and escape internal double quotes by doubling them (`"` -> `""`).
- Replace newlines in notes/freeform text with spaces before adding to CSV row.
- Write to `FileManager.default.temporaryDirectory.appendingPathComponent("CoffeeJournal.csv")` with UTF-8 encoding.
- Return URL on success, nil on failure.

**ExportTypes.swift** -- Transferable wrapper types:
- `import UniformTypeIdentifiers` and `import CoreTransferable`.
- `struct ExportedPDF: Transferable` with a `let url: URL` property and `FileRepresentation(exportedContentType: .pdf)` returning `SentTransferredFile(pdf.url)`.
- `struct ExportedCSV: Transferable` with a `let url: URL` property and `FileRepresentation(exportedContentType: .commaSeparatedText)` returning `SentTransferredFile(csv.url)`.
  </action>
  <verify>
    Build with `swift build` from project root. All three files should compile without errors. Verify CSVExporter.escapeCSVField handles comma, quote, and newline cases correctly by reading the implementation.
  </verify>
  <done>
    PDFExporter generates multi-page PDF with title page and brew entries. CSVExporter generates properly escaped CSV with all brew fields including tasting data. ExportedPDF and ExportedCSV Transferable types exist with FileRepresentation for correct file naming.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add export Menu to BrewLogListView toolbar and wire share sheet</name>
  <files>
    CoffeeJournal/Views/Brewing/BrewLogListView.swift
    CoffeeJournal/Views/History/BrewHistoryListContent.swift
    Package.swift
  </files>
  <action>
**BrewHistoryListContent.swift** -- Expose the filtered brews for the parent view to access:
- Add a `var onBrewsAvailable: (([BrewLog]) -> Void)?` optional callback property to the struct.
- In the `init`, accept this callback as a parameter (default nil).
- In the `body`, call `onBrewsAvailable?(filteredBrews)` using `.onChange(of: filteredBrews.count)` or `.onAppear` to pass the current filtered list up to the parent.

Actually, a simpler approach: Since the parent needs the filtered brews for export but BrewHistoryListContent owns the @Query, pass the brews up via a preference key or binding. The cleanest pattern for this codebase: add a `@Binding var exportBrews: [BrewLog]` parameter to BrewHistoryListContent. In the child body, use `.onAppear { exportBrews = filteredBrews }` and `.onChange(of: filteredBrews.count) { exportBrews = filteredBrews }` to keep it updated.

Update BrewHistoryListContent init to accept `exportBrews: Binding<[BrewLog]>` as a new parameter.

**BrewLogListView.swift** -- Add export state and Menu:
- Add `@State private var exportBrews: [BrewLog] = []` to track the currently displayed brews.
- Pass `$exportBrews` to BrewHistoryListContent.
- Add `@State private var isExporting = false` and `@State private var exportURL: URL?` and `@State private var exportType: String = ""` (to distinguish PDF vs CSV for the sheet).
- Add `@State private var showShareSheet = false`.
- In the toolbar, add a new `ToolbarItem(placement: .topBarLeading)` containing a `Menu` with:
  - `Button` labeled `Label("Export PDF", systemImage: "doc.richtext")` -- calls `exportPDF()`.
  - `Button` labeled `Label("Export CSV", systemImage: "tablecells")` -- calls `exportCSV()`.
  - The Menu label: `Image(systemName: "square.and.arrow.up").foregroundStyle(AppColors.primary)`.
- Move the Menu into the existing `ToolbarItemGroup(placement: .topBarLeading)` alongside the Compare and Statistics buttons.
- Implement `private func exportPDF()`:
  ```swift
  isExporting = true
  Task { @MainActor in
      exportURL = PDFExporter.generateJournal(brews: exportBrews)
      isExporting = false
      if exportURL != nil { showShareSheet = true; exportType = "pdf" }
  }
  ```
- Implement `private func exportCSV()`:
  ```swift
  isExporting = true
  Task { @MainActor in
      exportURL = CSVExporter.generateCSV(brews: exportBrews)
      isExporting = false
      if exportURL != nil { showShareSheet = true; exportType = "csv" }
  }
  ```
- Add `.sheet(isPresented: $showShareSheet)` that presents a share view. Since `ShareLink` needs to be declared with the item at compile time, use a conditional approach:
  ```swift
  .sheet(isPresented: $showShareSheet) {
      if let url = exportURL {
          if exportType == "pdf" {
              ShareLink(item: ExportedPDF(url: url), preview: SharePreview("Coffee Journal", image: Image(systemName: "doc.richtext")))
          } else {
              ShareLink(item: ExportedCSV(url: url), preview: SharePreview("Coffee Journal", image: Image(systemName: "tablecells")))
          }
      }
  }
  ```
  Note: If ShareLink inside a sheet doesn't work well, alternatively use the `activityViewController` UIKit wrapper approach or present the ShareLink directly in the toolbar conditionally. Test which approach works; if the sheet approach has issues, switch to conditionally showing ShareLink in the toolbar after generation completes.
- Disable the export Menu buttons when `exportBrews.isEmpty` or `isExporting`.

**Package.swift** -- Add the three new Export files to the sources array:
- `"CoffeeJournal/Services/Export/PDFExporter.swift"`
- `"CoffeeJournal/Services/Export/CSVExporter.swift"`
- `"CoffeeJournal/Services/Export/ExportTypes.swift"`
  </action>
  <verify>
    Build with `swift build` from project root. Verify BrewLogListView toolbar shows the export Menu icon alongside Compare and Statistics. Verify no compilation errors from the Binding and sheet wiring.
  </verify>
  <done>
    BrewLogListView toolbar has an export Menu with "Export PDF" and "Export CSV" options. Tapping either generates the file from the currently filtered brews and presents a share sheet with the correct file type and filename. BrewHistoryListContent passes filtered brews to parent via Binding.
  </done>
</task>

</tasks>

<verification>
1. Build succeeds with `swift build` -- all new files compile
2. PDFExporter.generateJournal exists with UIGraphicsPDFRenderer usage
3. CSVExporter.generateCSV exists with proper escaping and all brew fields
4. ExportedPDF and ExportedCSV conform to Transferable with FileRepresentation
5. BrewLogListView toolbar contains export Menu with PDF and CSV options
6. Export operates on filtered brews (not all brews)
</verification>

<success_criteria>
- PDFExporter generates a multi-page PDF with title page and brew entries, writing to temp directory
- CSVExporter generates a properly escaped CSV with header row and all brew fields including tasting data
- Transferable wrappers use FileRepresentation for correct filenames (CoffeeJournal.pdf, CoffeeJournal.csv)
- BrewLogListView toolbar has export Menu alongside existing Compare/Statistics buttons
- Exports use the currently filtered brew list from BrewHistoryListContent
- Share sheet presents with correct file type for user to save/share
</success_criteria>

<output>
After completion, create `.planning/phases/08-data-export/08-01-SUMMARY.md`
</output>
