---
phase: 08-data-export
plan: 02
type: execute
wave: 2
depends_on: ["08-01"]
files_modified:
  - CoffeeJournal/Views/Export/BrewCardView.swift
  - CoffeeJournal/Services/Export/BrewImageRenderer.swift
  - CoffeeJournal/Views/Brewing/BrewLogDetailView.swift
  - Package.swift
autonomous: true

must_haves:
  truths:
    - "User can export an individual brew as a shareable image"
    - "Exported image shows brew method, coffee, key parameters, rating, tasting chart, and date in a card layout"
    - "Share button is accessible from the brew detail view toolbar"
  artifacts:
    - path: "CoffeeJournal/Views/Export/BrewCardView.swift"
      provides: "Purpose-built card view designed for image export"
      contains: "BrewCardView"
    - path: "CoffeeJournal/Services/Export/BrewImageRenderer.swift"
      provides: "ImageRenderer wrapper converting BrewCardView to UIImage"
      contains: "ImageRenderer"
    - path: "CoffeeJournal/Views/Brewing/BrewLogDetailView.swift"
      provides: "Share toolbar button for individual brew image export"
      contains: "ShareLink"
  key_links:
    - from: "CoffeeJournal/Views/Brewing/BrewLogDetailView.swift"
      to: "CoffeeJournal/Services/Export/BrewImageRenderer.swift"
      via: "BrewImageRenderer.render(brew:) call for share preview"
      pattern: "BrewImageRenderer\\.render"
    - from: "CoffeeJournal/Services/Export/BrewImageRenderer.swift"
      to: "CoffeeJournal/Views/Export/BrewCardView.swift"
      via: "ImageRenderer(content: BrewCardView(brew:))"
      pattern: "BrewCardView"
---

<objective>
Create a shareable brew card image and wire it into the BrewLogDetailView toolbar as a share button.

Purpose: Enables users to share an individual brew as a polished, self-contained image suitable for messaging or social media, satisfying HIST-09.
Output: BrewCardView, BrewImageRenderer, and share toolbar button in BrewLogDetailView.
</objective>

<execution_context>
@/Users/ashok/.claude/get-shit-done/workflows/execute-plan.md
@/Users/ashok/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@.planning/phases/08-data-export/08-01-SUMMARY.md
@CoffeeJournal/Models/BrewLog.swift
@CoffeeJournal/Models/TastingNote.swift
@CoffeeJournal/Views/Brewing/BrewLogDetailView.swift
@CoffeeJournal/Views/Tasting/SpiderChartView.swift
@CoffeeJournal/Views/Components/MonochromeStyle.swift
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create BrewCardView and BrewImageRenderer</name>
  <files>
    CoffeeJournal/Views/Export/BrewCardView.swift
    CoffeeJournal/Services/Export/BrewImageRenderer.swift
  </files>
  <action>
**BrewCardView.swift** -- A self-contained SwiftUI view designed specifically for image export (not for in-app display). Create the `Views/Export/` directory.

Layout (top to bottom, left-aligned, within a fixed 400pt-wide container):
1. **Header**: Method name (AppTypography.title or .boldSystemFont equivalent) on the left, star rating (filled star SF symbols) on the right. Below method name: coffee display name in secondary text.
2. **Divider**: Thin horizontal line.
3. **Parameters grid**: 2-column `LazyVGrid` showing key parameters:
   - "Dose" with `"{dose}g"` value
   - "Ratio" with `brewRatioFormatted` value
   - "Time" with `brewTimeFormatted` value
   - "Temp" with `"{temp} C"` value (only if waterTemperature > 0)
   - Each item: value in headline font on top, label in caption below in secondary color.
4. **Grinder info** (if present): Single line showing grinder name and setting.
5. **Tasting attributes** (if tastingNote exists with any rated attributes): Use `SpiderChartView.fromTastingNote(note)` embedded at 150pt height. Only show if acidity > 0 || body > 0 || sweetness > 0.
6. **Footer**: Date (month/day/year format) on the left in caption/subtle text. "Coffee Journal" branding text on the right in caption/muted text.

Styling:
- `.frame(width: 400)` for consistent export width. Height is flexible (determined by content).
- `.background(Color.white)` for consistent appearance regardless of device dark mode.
- Use `AppSpacing.lg` padding, `AppSpacing.md` spacing between sections.
- All text in black/dark gray for readability on white background. Use `Color.black` and `Color.gray` explicitly (not AppColors which may adapt to dark mode) -- OR use `.environment(\.colorScheme, .light)` on the view to force light mode so AppColors resolve correctly.
- Apply `.environment(\.colorScheme, .light)` to the top-level VStack to ensure monochrome tokens resolve to their light-mode (black on white) values.

**BrewImageRenderer.swift** -- A `@MainActor` struct with:
- `static func render(brew: BrewLog, scale: CGFloat = 3.0) -> UIImage?`: Creates `ImageRenderer(content: BrewCardView(brew: brew))`, sets `renderer.scale = scale`, returns `renderer.uiImage`.
- `static func renderToData(brew: BrewLog, scale: CGFloat = 3.0) -> Data?`: Calls `render()` and returns `.pngData()`.
  </action>
  <verify>
    Build with `swift build` from project root. Verify BrewCardView has a fixed 400pt width, white background, and uses .environment(\.colorScheme, .light). Verify BrewImageRenderer sets scale to 3.0.
  </verify>
  <done>
    BrewCardView renders a polished brew card with method, coffee, parameters, optional spider chart, and branding. BrewImageRenderer converts the card to a high-resolution UIImage at 3x scale.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add share button to BrewLogDetailView toolbar</name>
  <files>
    CoffeeJournal/Views/Brewing/BrewLogDetailView.swift
    Package.swift
  </files>
  <action>
**BrewLogDetailView.swift** -- Add a share button to the toolbar:
- Add `@State private var renderedImage: UIImage?` property.
- Add a `.toolbar` modifier (or extend the existing one if there is one) with a `ToolbarItem(placement: .topBarTrailing)` containing:
  ```swift
  if let uiImage = renderedImage {
      ShareLink(
          item: Image(uiImage: uiImage),
          preview: SharePreview(
              brew.brewMethod?.name ?? "Brew",
              image: Image(uiImage: uiImage)
          )
      ) {
          Image(systemName: "square.and.arrow.up")
              .foregroundStyle(AppColors.primary)
      }
  } else {
      ProgressView()
  }
  ```
- In the existing `.task` modifier (which already calls `insightsViewModel.extractFlavors`), add the image rendering:
  ```swift
  renderedImage = BrewImageRenderer.render(brew: brew)
  ```
  This renders the brew card on first appearance. Since BrewImageRenderer is @MainActor and .task runs on MainActor, this is safe.

Note: The existing `.task` modifier on the body's ScrollView already does async work. Add the image rendering there so the share button becomes available shortly after the view appears.

**Package.swift** -- Add the new files to the sources array:
- `"CoffeeJournal/Views/Export/BrewCardView.swift"`
- `"CoffeeJournal/Services/Export/BrewImageRenderer.swift"`
  </action>
  <verify>
    Build with `swift build` from project root. Verify BrewLogDetailView has a share toolbar button with square.and.arrow.up icon. Verify ShareLink uses Image(uiImage:) with the rendered brew card image.
  </verify>
  <done>
    BrewLogDetailView toolbar shows a share button (square.and.arrow.up icon) that presents a ShareLink with the rendered brew card image. Image is rendered at 3x scale for high-quality sharing. Share button shows ProgressView while image is being rendered.
  </done>
</task>

</tasks>

<verification>
1. Build succeeds with `swift build` -- all new files compile
2. BrewCardView has fixed 400pt width, white background, forced light colorScheme
3. BrewImageRenderer.render returns UIImage at 3x scale
4. BrewLogDetailView toolbar contains share button with ShareLink
5. Share preview shows method name and brew card image
</verification>

<success_criteria>
- BrewCardView displays method, coffee, parameters grid, optional spider chart, date, and branding in a 400pt-wide card
- BrewImageRenderer converts the card to a UIImage at 3x scale for retina-quality sharing
- BrewLogDetailView has a share toolbar button (square.and.arrow.up) that presents a ShareLink
- ShareLink shares the rendered brew card image with proper preview
- Card uses monochrome styling on white background regardless of device dark mode setting
</success_criteria>

<output>
After completion, create `.planning/phases/08-data-export/08-02-SUMMARY.md`
</output>
