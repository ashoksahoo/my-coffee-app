---
phase: 07-apple-intelligence
plan: 02
type: execute
wave: 2
depends_on: ["07-01"]
files_modified:
  - CoffeeJournal/ViewModels/InsightsViewModel.swift
  - CoffeeJournal/Views/Insights/FlavorInsightView.swift
  - CoffeeJournal/Views/Insights/BrewPatternCard.swift
  - CoffeeJournal/Views/Insights/BrewSuggestionBanner.swift
  - CoffeeJournal/Views/Brewing/BrewLogDetailView.swift
  - CoffeeJournal/Views/History/StatisticsDashboardView.swift
  - CoffeeJournal/Views/Brewing/AddBrewLogView.swift
autonomous: true

must_haves:
  truths:
    - "Brew detail view shows extracted flavor descriptors from freeform tasting notes as tagged chips"
    - "Statistics dashboard displays brewing pattern insights (grind preferences by origin, optimal ratios by method)"
    - "AddBrewLogView shows a suggestion banner with recommended parameters when a bean and method are selected"
    - "All insight features degrade gracefully -- empty states shown when no data or unsupported hardware"
  artifacts:
    - path: "CoffeeJournal/ViewModels/InsightsViewModel.swift"
      provides: "InsightsViewModel driving flavor extraction, pattern analysis, and suggestion display"
      contains: "class InsightsViewModel"
    - path: "CoffeeJournal/Views/Insights/FlavorInsightView.swift"
      provides: "Extracted flavors display for brew detail view"
      contains: "struct FlavorInsightView"
    - path: "CoffeeJournal/Views/Insights/BrewPatternCard.swift"
      provides: "Pattern insight card for statistics dashboard"
      contains: "struct BrewPatternCard"
    - path: "CoffeeJournal/Views/Insights/BrewSuggestionBanner.swift"
      provides: "Suggestion banner for AddBrewLogView"
      contains: "struct BrewSuggestionBanner"
  key_links:
    - from: "CoffeeJournal/Views/Brewing/BrewLogDetailView.swift"
      to: "CoffeeJournal/Views/Insights/FlavorInsightView.swift"
      via: "FlavorInsightView embedded in tastingNotesSection"
      pattern: "FlavorInsightView"
    - from: "CoffeeJournal/Views/History/StatisticsDashboardView.swift"
      to: "CoffeeJournal/Views/Insights/BrewPatternCard.swift"
      via: "Insights section with BrewPatternCard ForEach after existing charts"
      pattern: "BrewPatternCard"
    - from: "CoffeeJournal/Views/Brewing/AddBrewLogView.swift"
      to: "CoffeeJournal/Views/Insights/BrewSuggestionBanner.swift"
      via: "BrewSuggestionBanner shown after coffee/method selection sections"
      pattern: "BrewSuggestionBanner"
    - from: "CoffeeJournal/ViewModels/InsightsViewModel.swift"
      to: "CoffeeJournal/Services/Insights/InsightsService.swift"
      via: "InsightsServiceFactory.makeService() for service selection"
      pattern: "InsightsServiceFactory"
---

<objective>
Build the AI insights UI layer and wire it into existing views: flavor extraction display in brew detail, pattern insights in statistics dashboard, and brew parameter suggestions in the add brew form.

Purpose: Surface AI-01 through AI-05 to users. Flavor descriptors appear in brew detail views (AI-01, AI-05). Brewing patterns appear in the statistics dashboard (AI-02, AI-05). Parameter suggestions appear when logging a new brew (AI-03). All features degrade gracefully on unsupported hardware (AI-04).

Output: InsightsViewModel, three insight view components, and modifications to BrewLogDetailView, StatisticsDashboardView, and AddBrewLogView.
</objective>

<execution_context>
@/Users/ashok/.claude/get-shit-done/workflows/execute-plan.md
@/Users/ashok/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-apple-intelligence/07-RESEARCH.md
@.planning/phases/07-apple-intelligence/07-01-SUMMARY.md
@CoffeeJournal/Views/Brewing/BrewLogDetailView.swift
@CoffeeJournal/Views/History/StatisticsDashboardView.swift
@CoffeeJournal/Views/Brewing/AddBrewLogView.swift
@CoffeeJournal/ViewModels/BrewLogViewModel.swift
@CoffeeJournal/Services/Insights/InsightsService.swift
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create InsightsViewModel and insight view components</name>
  <files>
    CoffeeJournal/ViewModels/InsightsViewModel.swift
    CoffeeJournal/Views/Insights/FlavorInsightView.swift
    CoffeeJournal/Views/Insights/BrewPatternCard.swift
    CoffeeJournal/Views/Insights/BrewSuggestionBanner.swift
  </files>
  <action>
Create `CoffeeJournal/Views/Insights/` directory.

**InsightsViewModel.swift** — @Observable ViewModel following existing project pattern:

1. `import Foundation` and `import SwiftData`
2. `@Observable class InsightsViewModel`:
   - `private let service: any InsightsService`
   - `init()` — sets `service = InsightsServiceFactory.makeService()`

   Flavor extraction state:
   - `var extractedFlavors: [ExtractedFlavor] = []`
   - `var isExtractingFlavors: Bool = false`
   - `func extractFlavors(from text: String) async` — set isExtractingFlavors=true, call `service.extractFlavors(from: text)`, set results, set isExtractingFlavors=false. Guard against empty text (return empty array).

   Pattern analysis state:
   - `var patterns: [BrewPattern] = []`
   - `func analyzePatterns(brews: [BrewLog])` — call `service.analyzePatterns(brews: brews)`, set results

   Suggestion state:
   - `var currentSuggestion: BrewSuggestion? = nil`
   - `func fetchSuggestion(for bean: CoffeeBean?, method: BrewMethod?, history: [BrewLog])` — guard both bean and method are non-nil, call `service.suggestParameters(for:method:history:)`, set result

**FlavorInsightView.swift** — Extracted flavor display for brew detail:

1. Monochrome design following project conventions (AppTypography, AppColors, AppSpacing)
2. `struct FlavorInsightView: View`:
   - Properties: `let flavors: [ExtractedFlavor]`, `let isLoading: Bool`
   - If `isLoading`: show `ProgressView()` with "Analyzing flavors..." caption
   - If `flavors.isEmpty` and not loading: show nothing (return `EmptyView()`)
   - If flavors present: show section header "AI-Extracted Flavors" with `sparkles` SF Symbol icon
   - Use `FlowLayout(spacing: 8)` (already exists in codebase from Phase 4) to display flavors as capsule chips
   - Each chip: Text(flavor.name) in capsule with monochrome styling, opacity based on confidence (min 0.5, max 1.0)
   - Show confidence indicator: high confidence (>= 0.8) = solid fill, medium (0.5-0.8) = lighter fill, low (<0.5) = outline only
   - All monochrome -- use AppColors.primary with varying opacity, no color

**BrewPatternCard.swift** — Pattern insight card for statistics dashboard:

1. `struct BrewPatternCard: View`:
   - Property: `let pattern: BrewPattern`
   - Monochrome card matching existing StatCard style in StatisticsDashboardView
   - Layout: icon (from pattern category), title, description
   - Category icons: `.grindPreference` = "gearshape.2", `.ratioOptimal` = "scalemass", `.methodFavorite` = "cup.and.saucer", `.originTrend` = "globe"
   - Background: `AppColors.secondaryBackground`, rounded corners 8
   - Text: title in `AppTypography.headline`, description in `AppTypography.caption` with `AppColors.secondary`

**BrewSuggestionBanner.swift** — Suggestion banner for AddBrewLogView:

1. `struct BrewSuggestionBanner: View`:
   - Properties: `let suggestion: BrewSuggestion`, `let onApply: () -> Void`
   - Monochrome banner with "lightbulb" SF Symbol header
   - Display: "Based on {N} similar brews" with confidence badge
   - Show suggested parameters in compact format: Dose, Water/Yield, Temperature, Grinder Setting, Time (only non-nil values)
   - "Apply Suggestions" button (monochrome, `AppColors.primary` foreground) that calls `onApply`
   - Confidence display: `.high` = "High confidence", `.medium` = "Moderate", `.low` = "Rough estimate" — use `AppColors.primary` with varying opacity
   - Background: `AppColors.secondaryBackground` with rounded corners 8 and subtle border
   - Dismissible: include an X button that hides the banner (use local @State)
  </action>
  <verify>
Build the project. Confirm InsightsViewModel uses @Observable pattern consistent with SetupWizardViewModel and BrewLogViewModel. Confirm FlavorInsightView uses FlowLayout (from Phase 4). Confirm all views use AppColors/AppTypography/AppSpacing design tokens. Confirm no color is used anywhere (monochrome constraint).
  </verify>
  <done>
InsightsViewModel drives all three insight features (flavor extraction, pattern analysis, brew suggestions) via InsightsServiceFactory. FlavorInsightView displays extracted flavors as confidence-weighted monochrome chips. BrewPatternCard displays pattern insights matching existing StatCard style. BrewSuggestionBanner shows parameter suggestions with apply action and confidence level.
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire insight views into BrewLogDetailView, StatisticsDashboardView, and AddBrewLogView</name>
  <files>
    CoffeeJournal/Views/Brewing/BrewLogDetailView.swift
    CoffeeJournal/Views/History/StatisticsDashboardView.swift
    CoffeeJournal/Views/Brewing/AddBrewLogView.swift
  </files>
  <action>
**BrewLogDetailView.swift** — Add extracted flavor insights (AI-01, AI-05):

1. Add `@State private var insightsViewModel = InsightsViewModel()` at the top of the struct
2. In `tastingNotesSection`, after the existing flavor tags display and before the "View Flavor Profile" NavigationLink, add:
   - `FlavorInsightView(flavors: insightsViewModel.extractedFlavors, isLoading: insightsViewModel.isExtractingFlavors)`
   - This shows AI-extracted flavors in addition to manually selected flavor tags
3. Add `.task { }` modifier to the view body (or to tastingNotesSection):
   - Collect text to analyze: combine `brew.tastingNote?.freeformNotes` and `brew.notes` (both freeform text sources)
   - If combined text is non-empty, call `await insightsViewModel.extractFlavors(from: combinedText)`
   - This runs once when the view appears

**StatisticsDashboardView.swift** — Add pattern insights section (AI-02, AI-05):

1. Add `@State private var insightsViewModel = InsightsViewModel()` at the top
2. After the existing `topBeansChart` section (last chart), add a new section:
   ```
   insightsSection
   ```
3. Create `@ViewBuilder private var insightsSection: some View`:
   - Guard: only show if `!insightsViewModel.patterns.isEmpty`
   - Section header: "Brewing Insights" with `sparkles` SF Symbol, `AppTypography.headline`
   - `ForEach(insightsViewModel.patterns) { pattern in BrewPatternCard(pattern: pattern) }`
   - Layout: VStack with AppSpacing.sm spacing (like existing chart sections)
4. Add `.onAppear { insightsViewModel.analyzePatterns(brews: brews) }` to the ScrollView or the else branch (where brews are non-empty)
   - This triggers pattern analysis when dashboard loads with brew data

**AddBrewLogView.swift** — Add brew parameter suggestions (AI-03):

1. Add `@State private var insightsViewModel = InsightsViewModel()` at the top
2. Add `@State private var showSuggestion: Bool = true` for dismissible banner state
3. After `grinderSection` (the third Form section), add a conditional suggestion section:
   ```swift
   if let suggestion = insightsViewModel.currentSuggestion, showSuggestion {
       Section {
           BrewSuggestionBanner(suggestion: suggestion) {
               applySuggestion(suggestion)
           }
       }
   }
   ```
4. Create `private func applySuggestion(_ suggestion: BrewSuggestion)`:
   - Set `viewModel.dose = suggestion.dose`
   - If `suggestion.waterAmount != nil`: set `viewModel.waterAmount = suggestion.waterAmount!`
   - If `suggestion.yieldAmount != nil`: set `viewModel.yieldAmount = suggestion.yieldAmount!`
   - Set `viewModel.waterTemperature = suggestion.waterTemperature`
   - If `suggestion.grinderSetting != nil`: set `viewModel.grinderSetting = suggestion.grinderSetting!`
   - Set `viewModel.brewTime = suggestion.brewTime`
   - Also update manual time entry: `viewModel.brewTimeMinutes = Int(suggestion.brewTime) / 60`, `viewModel.brewTimeSeconds = Int(suggestion.brewTime) % 60`
5. Add `.onChange(of: viewModel.selectedBean) { ... }` and `.onChange(of: viewModel.selectedMethod) { ... }`:
   - Both trigger: `insightsViewModel.fetchSuggestion(for: viewModel.selectedBean, method: viewModel.selectedMethod, history: beans_history_query_results)`
   - For the brew history: add `@Query(sort: \BrewLog.createdAt, order: .reverse) private var allBrews: [BrewLog]` to AddBrewLogView
   - Reset `showSuggestion = true` when bean/method changes (so dismissed banner reappears for new combinations)
  </action>
  <verify>
Build the project. Verify:
1. BrewLogDetailView shows FlavorInsightView in the tasting notes section and triggers extraction on appear
2. StatisticsDashboardView shows an "Brewing Insights" section after existing charts when patterns are found
3. AddBrewLogView shows BrewSuggestionBanner after equipment selection sections when a suggestion is available
4. No compilation errors from imports or type mismatches
5. All views maintain monochrome constraint -- no color used
  </verify>
  <done>
BrewLogDetailView displays AI-extracted flavor descriptors from freeform tasting notes on appear. StatisticsDashboardView shows brewing pattern insights (grind preferences, optimal ratios) after existing charts. AddBrewLogView shows parameter suggestion banner when bean + method are selected, with "Apply" action that fills form fields. All features are monochrome, degrade gracefully with empty states, and require no network calls.
  </done>
</task>

</tasks>

<verification>
1. BrewLogDetailView displays FlavorInsightView with extracted flavors from freeform notes
2. StatisticsDashboardView displays BrewPatternCard for detected patterns after existing charts
3. AddBrewLogView displays BrewSuggestionBanner when bean+method selected and history has matching brews
4. Applying a suggestion fills dose, water, temperature, grinder setting, and brew time fields
5. All views handle empty state gracefully (no insights = no UI shown, not an error)
6. Monochrome design maintained throughout (no color)
7. No network calls (AI-04)
8. Project builds without errors
</verification>

<success_criteria>
- AI-extracted flavors appear in brew detail view when freeform tasting notes exist
- Brewing patterns appear in statistics dashboard when sufficient brew history exists
- Parameter suggestions appear in AddBrewLogView when bean + method match similar past brews
- Apply action fills form fields from suggestion
- All views degrade gracefully (empty states, no crashes)
- Monochrome constraint maintained
</success_criteria>

<output>
After completion, create `.planning/phases/07-apple-intelligence/07-02-SUMMARY.md`
</output>
