---
phase: 01-foundation-equipment
plan: 04
type: execute
wave: 3
depends_on: ["01-01", "01-03"]
files_modified:
  - CoffeeJournal/Views/Equipment/MethodDetailView.swift
  - CoffeeJournal/Views/Equipment/GrinderDetailView.swift
  - CoffeeJournal/Views/Equipment/EquipmentPhotoPickerView.swift
autonomous: true

must_haves:
  truths:
    - "User can view full details of a brew method including its pre-configured parameters"
    - "User can edit brew method name and notes"
    - "User can view full details of a grinder including its setting range"
    - "User can edit grinder name, type, notes, and setting range"
    - "User can add or replace a photo for any piece of equipment"
    - "Equipment photos are compressed before storage (max 1024px, JPEG 0.7 quality)"
    - "Usage statistics (brew count, last used) are displayed on detail screens"
  artifacts:
    - path: "CoffeeJournal/Views/Equipment/MethodDetailView.swift"
      provides: "Method detail with edit, stats, parameters, photo"
      contains: "BrewMethod"
    - path: "CoffeeJournal/Views/Equipment/GrinderDetailView.swift"
      provides: "Grinder detail with edit, stats, setting range, photo"
      contains: "Grinder"
    - path: "CoffeeJournal/Views/Equipment/EquipmentPhotoPickerView.swift"
      provides: "Reusable photo picker with compression"
      contains: "PhotosPicker"
  key_links:
    - from: "MethodDetailView.swift"
      to: "BrewMethod.swift"
      via: "Binds to BrewMethod @Model for direct editing"
      pattern: "@Bindable var method: BrewMethod"
    - from: "GrinderDetailView.swift"
      to: "Grinder.swift"
      via: "Binds to Grinder @Model for direct editing"
      pattern: "@Bindable var grinder: Grinder"
    - from: "EquipmentPhotoPickerView.swift"
      to: "ImageCompressor.swift"
      via: "Compresses selected photo before saving"
      pattern: "ImageCompressor\\.compress"
    - from: "MethodListView.swift"
      to: "MethodDetailView.swift"
      via: "NavigationLink destination (replace placeholder from Plan 03)"
      pattern: "NavigationLink.*MethodDetailView"
---

<objective>
Build equipment detail/edit screens and photo functionality. Users tap an equipment item in the list to see its full details, edit properties, view usage statistics, and add/replace photos. This plan also wires the NavigationLink destinations that were placeholders in Plan 03.

Purpose: Detail views complete the equipment CRUD cycle (Create from Plan 03, Read/Update here, Delete from Plan 03's swipe actions). Photo support fulfills EQ-06 and the user decision that equipment photos replace default icons in list view.
Output: MethodDetailView, GrinderDetailView, and reusable EquipmentPhotoPickerView with image compression.
</objective>

<execution_context>
@/Users/ashok/.claude/get-shit-done/workflows/execute-plan.md
@/Users/ashok/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation-equipment/01-RESEARCH.md
@.planning/phases/01-foundation-equipment/01-CONTEXT.md
@.planning/phases/01-foundation-equipment/01-01-SUMMARY.md
@.planning/phases/01-foundation-equipment/01-03-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create MethodDetailView and GrinderDetailView with editing</name>
  <files>
    CoffeeJournal/Views/Equipment/MethodDetailView.swift
    CoffeeJournal/Views/Equipment/GrinderDetailView.swift
  </files>
  <action>
    1. **MethodDetailView.swift** -- Detail screen for a brew method:
       - Accept `@Bindable var method: BrewMethod` (SwiftData @Bindable for direct model editing).
       - Layout in a scrollable Form or List with sections:

         **Section 1: Photo + Name**
         - Large photo area at top (200pt height). If photoData exists, show the image. If nil, show large SF Symbol for the method category in a monochrome circle background.
         - "Change Photo" / "Add Photo" button below the photo area (triggers EquipmentPhotoPickerView).
         - TextField for method name, bound to `$method.name`.

         **Section 2: Details**
         - Category displayed as read-only text (e.g., "Pour Over") -- category is set at creation and not editable.
         - TextField for notes, bound to `$method.notes`. Multi-line text editor (TextEditor or `.lineLimit(3...6)` on TextField).

         **Section 3: Pre-configured Parameters (read-only)**
         - Title: "Brew Parameters"
         - Display the parameter list based on method.category:
           - Espresso: Dose (g) required, Yield (g) required, Time required, Water Temperature required, Pressure Profile optional
           - Pour Over: Dose (g) required, Water Amount (g) required, Time required
           - Immersion/Other: Dose (g) required, Water Amount (g) required, Time required, Water Temperature required
         - Show each parameter as a row with name and "Required"/"Optional" badge
         - Add a footer note: "Parameters are used when logging brews with this method"
         - This is READ-ONLY display per user decision (v1: pre-configured, no customization)

         **Section 4: Usage Statistics**
         - Brew count: "X brews" (or "No brews yet" if 0)
         - Last used: relative date ("3 days ago") or "Never used"
         - Created: date of creation
         - Empty state for zero brews: "Use this method in a brew to see stats here"

       - Toolbar: trailing edit button is not needed since fields are directly editable.
       - Navigation title: method name.
       - Auto-save: SwiftData auto-saves on model property changes. Set `method.updatedAt = Date()` when name or notes change (use onChange modifier).
       - Monochrome styling throughout.

    2. **GrinderDetailView.swift** -- Detail screen for a grinder:
       - Accept `@Bindable var grinder: Grinder`.
       - Layout in a scrollable Form or List with sections:

         **Section 1: Photo + Name**
         - Large photo area (same as MethodDetailView). SF Symbol fallback based on grinder type.
         - "Change Photo" / "Add Photo" button.
         - TextField for grinder name, bound to `$grinder.name`.

         **Section 2: Details**
         - Picker for grinder type, bound to `$grinder.grinderType` (via the computed property or the raw value).
         - Section "Setting Range":
           - Stepper or TextField for settingMin, bound to `$grinder.settingMin`
           - Stepper or TextField for settingMax, bound to `$grinder.settingMax`
           - Stepper or TextField for settingStep, bound to `$grinder.settingStep`
           - Display preview: "Range: 0 - 40, step 1"
         - TextEditor for notes, bound to `$grinder.notes`.

         **Section 3: Usage Statistics**
         - Same pattern as MethodDetailView: brew count, last used, created date.
         - Empty state for zero brews.

       - Auto-save with updatedAt timestamp.
       - Navigation title: grinder name.
       - Monochrome styling.

    3. **Update MethodListView.swift and GrinderListView.swift** (from Plan 03):
       - Replace the placeholder NavigationLink destinations with actual `MethodDetailView(method: method)` and `GrinderDetailView(grinder: grinder)`.
       - Ensure NavigationLink uses value-based navigation with `.navigationDestination(for:)` OR inline destination -- whichever compiles cleanly with @Bindable.
  </action>
  <verify>
    Run `xcodebuild build` and confirm MethodDetailView and GrinderDetailView compile. Verify both views accept @Bindable model parameters. Verify MethodDetailView shows pre-configured parameters based on category. Verify the NavigationLinks in list views point to real detail views.
  </verify>
  <done>
    MethodDetailView shows method photo, name (editable), category, notes (editable), pre-configured brew parameters (read-only per user decision), and usage statistics. GrinderDetailView shows grinder photo, name, type, setting range (all editable), notes, and usage stats. List views navigate to real detail views.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create EquipmentPhotoPickerView with compression</name>
  <files>
    CoffeeJournal/Views/Equipment/EquipmentPhotoPickerView.swift
  </files>
  <action>
    Create a reusable photo picker component that both detail views use for equipment photos.

    1. **EquipmentPhotoPickerView.swift**:
       - Import PhotosUI for `PhotosPicker` and `PhotosPickerItem`.
       - Accept `@Binding var photoData: Data?` -- binds directly to the model's photoData property.
       - `@State private var selectedItem: PhotosPickerItem?`
       - Layout:
         - Display current photo if photoData is not nil: `Image(uiImage:)` from photoData, resizable, aspect fill, clipped to rounded rectangle (16pt corner radius), frame height 200.
         - If no photo: show a dashed border rounded rectangle placeholder with SF Symbol "camera" and text "Add Photo" centered inside.
         - Below the image area: `PhotosPicker(selection: $selectedItem, matching: .images)` styled as a monochrome bordered button ("Change Photo" if photo exists, "Add Photo" if not).
         - Optional "Remove Photo" button (only shown when photo exists) that sets photoData to nil.

       - On `selectedItem` change (`.onChange(of: selectedItem)`):
         - Load the image data: `selectedItem?.loadTransferable(type: Data.self)`
         - Compress using `ImageCompressor.compress(imageData:maxDimension:quality:)` with maxDimension 1024 and quality 0.7.
         - Set `photoData = compressedData`.
         - This is async -- use Task {} block.

       - Handle loading state: show a ProgressView while the photo is being loaded/compressed.
       - Error handling: if loadTransferable fails, show a brief error message (Text in red... wait, no color -- show as bold text "Failed to load photo").

    2. **Wire into detail views**: In both MethodDetailView and GrinderDetailView, replace the placeholder photo area with:
       ```swift
       EquipmentPhotoPickerView(photoData: $method.photoData)
       // or
       EquipmentPhotoPickerView(photoData: $grinder.photoData)
       ```

    Per user decision: equipment photos replace default icons in list view. This is already handled by EquipmentRow in Plan 01 (it checks photoData and shows photo or SF Symbol). So once photos are saved to the model here, they automatically appear in the list.

    IMPORTANT: Always compress before storing. Raw iPhone photos are 5-15MB each. With CloudKit sync, uncompressed photos would rapidly consume the user's iCloud quota. The ImageCompressor from Plan 01 handles this.
  </action>
  <verify>
    Run `xcodebuild build` and confirm EquipmentPhotoPickerView compiles. Verify it imports PhotosUI and uses PhotosPicker. Verify it calls ImageCompressor.compress before setting photoData. Verify detail views use EquipmentPhotoPickerView.
  </verify>
  <done>
    EquipmentPhotoPickerView presents native PhotosPicker, compresses selected images to max 1024px JPEG at 0.7 quality, and saves to the model's photoData. Both detail views integrate the photo picker. Photos appear as equipment icons in list views via EquipmentRow.
  </done>
</task>

</tasks>

<verification>
- `xcodebuild build` succeeds with zero errors
- MethodDetailView shows pre-configured parameters (read-only, per user decision)
- Both detail views allow editing name, notes, and other relevant fields
- Photo picker compresses images before storage (ImageCompressor.compress called)
- Detail views show usage statistics (brew count, last used)
- NavigationLinks from list views resolve to real detail views
- All monochrome styling
</verification>

<success_criteria>
- Users can view and edit all equipment details
- Pre-configured brew parameters display correctly per method category (espresso, pour-over, other)
- Photos are compressed and saved to SwiftData models
- Photos appear as icons in equipment list rows
- Usage statistics display on detail screens
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-equipment/01-04-SUMMARY.md`
</output>
