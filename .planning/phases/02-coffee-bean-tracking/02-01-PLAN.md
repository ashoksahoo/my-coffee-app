---
phase: 02-coffee-bean-tracking
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - CoffeeJournal/Models/RoastLevel.swift
  - CoffeeJournal/Models/ProcessingMethod.swift
  - CoffeeJournal/Utilities/FreshnessCalculator.swift
  - CoffeeJournal/Models/CoffeeBean.swift
  - CoffeeJournal/Views/Beans/FreshnessIndicatorView.swift
  - CoffeeJournal/Views/Beans/BeanRow.swift
  - CoffeeJournal/Views/Beans/BeanListView.swift
  - CoffeeJournal/Views/Beans/AddBeanView.swift
  - CoffeeJournal/Views/Beans/BeanDetailView.swift
  - CoffeeJournal/Views/MainTabView.swift
autonomous: true

must_haves:
  truths:
    - "User can add a coffee with roaster, origin, region, variety, processing method, and roast level"
    - "User can see days since roast and a visual freshness indicator on each bean"
    - "User can search their coffee collection by roaster or origin"
    - "User can archive beans and toggle between active/archived views"
    - "User can add photos to coffee entries"
    - "Coffee data syncs across devices via iCloud (automatic -- CloudKit already configured)"
  artifacts:
    - path: "CoffeeJournal/Models/RoastLevel.swift"
      provides: "RoastLevel enum with displayName"
      contains: "enum RoastLevel"
    - path: "CoffeeJournal/Models/ProcessingMethod.swift"
      provides: "ProcessingMethod enum with displayName"
      contains: "enum ProcessingMethod"
    - path: "CoffeeJournal/Utilities/FreshnessCalculator.swift"
      provides: "FreshnessLevel enum and daysSinceRoast computation"
      contains: "struct FreshnessCalculator"
    - path: "CoffeeJournal/Models/CoffeeBean.swift"
      provides: "Computed properties for enums, freshness, displayName"
      contains: "extension CoffeeBean"
    - path: "CoffeeJournal/Views/Beans/FreshnessIndicatorView.swift"
      provides: "Monochrome freshness badge (icon + days)"
      contains: "struct FreshnessIndicatorView"
    - path: "CoffeeJournal/Views/Beans/BeanRow.swift"
      provides: "List row component showing roaster, origin, freshness, photo"
      contains: "struct BeanRow"
    - path: "CoffeeJournal/Views/Beans/BeanListView.swift"
      provides: "Parent/child @Query list with .searchable and archive toggle"
      contains: "struct BeanListView"
    - path: "CoffeeJournal/Views/Beans/AddBeanView.swift"
      provides: "Sheet form for adding new beans"
      contains: "struct AddBeanView"
    - path: "CoffeeJournal/Views/Beans/BeanDetailView.swift"
      provides: "@Bindable detail/edit view with all fields"
      contains: "struct BeanDetailView"
  key_links:
    - from: "CoffeeJournal/Views/Beans/BeanListView.swift"
      to: "CoffeeJournal/Views/Beans/BeanRow.swift"
      via: "ForEach rendering in BeanListContent"
      pattern: "BeanRow\\("
    - from: "CoffeeJournal/Views/Beans/BeanRow.swift"
      to: "CoffeeJournal/Views/Beans/FreshnessIndicatorView.swift"
      via: "Trailing freshness badge in row"
      pattern: "FreshnessIndicatorView\\("
    - from: "CoffeeJournal/Views/Beans/BeanListView.swift"
      to: "CoffeeJournal/Views/Beans/BeanDetailView.swift"
      via: "NavigationLink from list row"
      pattern: "NavigationLink.*BeanDetailView"
    - from: "CoffeeJournal/Views/Beans/BeanListView.swift"
      to: "CoffeeJournal/Views/Beans/AddBeanView.swift"
      via: "Sheet presentation from toolbar button"
      pattern: "\\.sheet.*AddBeanView"
    - from: "CoffeeJournal/Views/MainTabView.swift"
      to: "CoffeeJournal/Views/Beans/BeanListView.swift"
      via: "Beans tab in TabView"
      pattern: "BeanListView\\(\\)"
---

<objective>
Create the complete bean management vertical slice: domain enums, freshness computation, CRUD views (list with search/archive, add form, detail/edit), and tab wiring.

Purpose: Delivers requirements BEAN-01 (add coffee with full origin details), BEAN-02 (days since roast), BEAN-03 (bag photos), BEAN-04 (active/archived), BEAN-06 (visual freshness indicator), BEAN-07 (search by roaster/origin), BEAN-08 (iCloud sync -- automatic).
Output: Working Beans tab with full CRUD, search, archive, and freshness tracking.
</objective>

<execution_context>
@/Users/ashok/.claude/get-shit-done/workflows/execute-plan.md
@/Users/ashok/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-coffee-bean-tracking/02-RESEARCH.md

Key codebase files to reference for patterns:
@CoffeeJournal/Models/CoffeeBean.swift
@CoffeeJournal/Models/Grinder.swift
@CoffeeJournal/Models/GrinderType.swift
@CoffeeJournal/Views/Equipment/GrinderListView.swift
@CoffeeJournal/Views/Equipment/GrinderDetailView.swift
@CoffeeJournal/Views/Equipment/AddGrinderView.swift
@CoffeeJournal/Views/Equipment/EquipmentPhotoPickerView.swift
@CoffeeJournal/Views/Components/EquipmentRow.swift
@CoffeeJournal/Views/Components/MonochromeStyle.swift
@CoffeeJournal/Views/Components/EmptyStateView.swift
@CoffeeJournal/Views/MainTabView.swift
</context>

<tasks>

<task type="auto">
  <name>Task 1: Domain enums, freshness calculator, and CoffeeBean computed properties</name>
  <files>
    CoffeeJournal/Models/RoastLevel.swift
    CoffeeJournal/Models/ProcessingMethod.swift
    CoffeeJournal/Utilities/FreshnessCalculator.swift
    CoffeeJournal/Models/CoffeeBean.swift
  </files>
  <action>
    Create THREE new files and extend ONE existing file:

    1. **RoastLevel.swift** (new, in Models/):
       - `enum RoastLevel: String, Codable, CaseIterable` with cases: `light`, `mediumLight` ("medium_light"), `medium`, `mediumDark` ("medium_dark"), `dark`
       - Computed `displayName: String` property (e.g., "Medium-Light")
       - Follow exact same pattern as GrinderType.swift (String raw values, CaseIterable, Codable)

    2. **ProcessingMethod.swift** (new, in Models/):
       - `enum ProcessingMethod: String, Codable, CaseIterable` with cases: `washed`, `natural`, `honey`, `anaerobic`, `other`
       - Computed `displayName: String` property (e.g., "Washed", "Natural", "Honey", "Anaerobic", "Other")
       - Same pattern as GrinderType.swift

    3. **FreshnessCalculator.swift** (new, in Utilities/):
       - `enum FreshnessLevel` with cases: `peak` (0-14 days), `acceptable` (15-30 days), `stale` (31+ days)
       - Computed properties: `label: String` ("Fresh", "OK", "Stale"), `opacity: Double` (1.0, 0.6, 0.3), `iconName: String` ("checkmark.circle.fill", "minus.circle", "exclamationmark.circle")
       - `struct FreshnessCalculator` with static functions:
         - `daysSinceRoast(from roastDate: Date) -> Int` using `Calendar.current.dateComponents([.day], from:to:)` against `Date.now`, clamped to `max(0, ...)`
         - `freshnessLevel(daysSinceRoast days: Int) -> FreshnessLevel` with switch on 0...14, 15...30, default

    4. **CoffeeBean.swift** (extend existing -- add `extension CoffeeBean` below the `@Model` class):
       - `var roastLevelEnum: RoastLevel` -- get/set computed property mapping to/from `roastLevel` String field (default `.medium`)
       - `var processingMethodEnum: ProcessingMethod` -- get/set computed property mapping to/from `processingMethod` String field (default `.other`)
       - `var daysSinceRoast: Int?` -- computed from `roastDate` using `FreshnessCalculator.daysSinceRoast(from:)`, returns nil if `roastDate` is nil
       - `var freshnessLevel: FreshnessLevel?` -- computed from `daysSinceRoast` using `FreshnessCalculator.freshnessLevel(daysSinceRoast:)`, returns nil if no roast date
       - `var displayName: String` -- prefer `name` if non-empty, then "\(roaster) - \(origin)" if both non-empty, then `roaster`, then `origin`, then "Unnamed Coffee"
       - Do NOT modify any existing stored properties or the `@Model` class itself. Only add the extension below.

    IMPORTANT: Monochrome design constraint -- FreshnessLevel uses opacity levels (1.0/0.6/0.3) and SF Symbol icons, NOT color. No green/yellow/red anywhere.
  </action>
  <verify>
    `swift build` from project root compiles without errors. New files exist at expected paths. CoffeeBean extension compiles correctly with the existing @Model class.
  </verify>
  <done>
    RoastLevel and ProcessingMethod enums exist with displayName. FreshnessCalculator computes days-since-roast and freshness levels. CoffeeBean has computed accessors for enum properties, freshness, and displayName. All monochrome (no color).
  </done>
</task>

<task type="auto">
  <name>Task 2: Bean CRUD views (list with search/archive, add form, detail/edit, row component, freshness indicator)</name>
  <files>
    CoffeeJournal/Views/Beans/FreshnessIndicatorView.swift
    CoffeeJournal/Views/Beans/BeanRow.swift
    CoffeeJournal/Views/Beans/BeanListView.swift
    CoffeeJournal/Views/Beans/AddBeanView.swift
    CoffeeJournal/Views/Beans/BeanDetailView.swift
  </files>
  <action>
    Create FIVE new files in a new `Views/Beans/` directory:

    1. **FreshnessIndicatorView.swift**:
       - Accepts `let roastDate: Date?`
       - When roastDate is nil, renders nothing (empty view)
       - When roastDate is set: compute days and level using FreshnessCalculator, show HStack with SF Symbol icon (from `FreshnessLevel.iconName`) + "\(days)d" text
       - Font: `AppTypography.caption`, fontWeight: `.bold` for `.peak`, `.regular` otherwise
       - foregroundStyle: `AppColors.primary.opacity(level.opacity)` -- monochrome opacity encoding
       - Use `.onAppear` to ensure freshness recalculates each time the view appears (computed from Date.now each render, no caching)

    2. **BeanRow.swift**:
       - Accepts `let bean: CoffeeBean`
       - Layout follows EquipmentRow pattern: HStack with photo thumbnail (40x40 circle, `leaf` SF Symbol fallback), VStack with `bean.displayName` (headline) + origin/variety subtitle (caption), trailing FreshnessIndicatorView
       - Subtitle: if bean.origin and bean.variety are both non-empty, show "\(bean.origin) \u{00B7} \(bean.variety)"; if only origin, show origin; if only variety, show variety; if neither, show roastLevelEnum.displayName
       - If bean.isArchived, show a subtle "Archived" badge (AppTypography.caption, AppColors.muted) below the subtitle

    3. **BeanListView.swift** (parent/child @Query pattern for dynamic search):
       - **Parent: `BeanListView`**
         - `@State private var searchText = ""`
         - `@State private var showArchived = false`
         - `@State private var showingAddSheet = false`
         - Body: VStack with Picker("Filter", selection: $showArchived) using `.segmented` style ("Active" tag false, "Archived" tag true), then `BeanListContent(searchText: searchText, showArchived: showArchived)`, then `.searchable(text: $searchText, prompt: "Search by roaster or origin")`
         - `.navigationTitle("Beans")`
         - Toolbar: ToolbarItem(placement: .topBarTrailing) with `Button` showing `Image(systemName: "plus")` that sets `showingAddSheet = true`. (Plan 02 will upgrade this to a Menu with scan option.)
         - `.sheet(isPresented: $showingAddSheet)` wrapping `NavigationStack { AddBeanView() }`

       - **Child: `BeanListContent`** (in same file):
         - `let searchText: String`, `let showArchived: Bool`
         - `@Query private var beans: [CoffeeBean]`
         - `@Environment(\.modelContext) private var modelContext`
         - In `init(searchText:showArchived:)`: configure `_beans` with `#Predicate<CoffeeBean>`:
           - When `searchText.isEmpty`: filter by `bean.isArchived == showArchived`, sort by `SortDescriptor(\.createdAt, order: .reverse)`
           - When `searchText` is non-empty: filter by `(bean.roaster.localizedStandardContains(searchText) || bean.origin.localizedStandardContains(searchText)) && bean.isArchived == showArchived`, same sort
           - Store both `searchText` and `showArchived` as `let` properties for child init assignment
         - Body: if beans.isEmpty show EmptyStateView (systemImage: "leaf", title: showArchived ? "No Archived Beans" : "No Beans Yet", message: showArchived ? "Archive beans you're no longer using" : "Add your first coffee to get started"), else List with ForEach, NavigationLink to BeanDetailView(bean:), label is BeanRow(bean:)
         - Swipe actions: trailing swipe with archive/unarchive toggle (systemImage: bean.isArchived ? "tray.and.arrow.up" : "archivebox") and destructive delete button
         - Archive swipe action: toggle `bean.isArchived`, set `bean.updatedAt = Date()`
         - Delete swipe action: `modelContext.delete(bean)`
         - Use `.listStyle(.plain)` matching GrinderListView pattern

    4. **AddBeanView.swift**:
       - Follow AddGrinderView pattern exactly: @Environment modelContext + dismiss, @State properties for each field
       - Fields: `name` (String, optional -- placeholder "Name (optional)"), `roaster` (String, required), `origin` (String, required), `region` (String, optional), `variety` (String, optional), `processingMethod` (ProcessingMethod, default .other), `roastLevel` (RoastLevel, default .medium), `roastDate` (Date?, optional -- use toggle to enable DatePicker), `notes` (String, optional)
       - Form sections:
         - "Coffee Info": TextField for name (optional), TextField for roaster (required), TextField for origin (required)
         - "Origin Details": TextField for region, TextField for variety
         - "Roast": Picker for roastLevel (iterate RoastLevel.allCases), Picker for processingMethod (iterate ProcessingMethod.allCases), Toggle "Roast Date" with DatePicker (.dateOnly) shown when toggled on
         - "Notes": TextField for notes (multiline, axis: .vertical, lineLimit 3...6)
       - `canSave` computed: `!roaster.trimmingCharacters(in: .whitespaces).isEmpty && !origin.trimmingCharacters(in: .whitespaces).isEmpty`
       - Save function: create CoffeeBean(), assign all fields (trim strings), set roastLevel to selectedRoastLevel.rawValue, processingMethod to selectedProcessingMethod.rawValue, insert into modelContext, dismiss
       - Toolbar: Cancel (leading), Save (trailing, disabled when !canSave)
       - `.navigationTitle("Add Coffee")`

    5. **BeanDetailView.swift**:
       - Follow GrinderDetailView pattern: `@Bindable var bean: CoffeeBean`, `@Environment(\.modelContext)`
       - Form sections:
         - Photo section: EquipmentPhotoPickerView(photoData: $bean.photoData) (reuse existing component), TextField for name
         - "Origin" section: TextField for roaster, TextField for origin, TextField for region, TextField for variety
         - "Roast" section: Picker for roastLevel bound to `$bean.roastLevel` using `ForEach(RoastLevel.allCases, id: \.rawValue)` with `.tag(type.rawValue)` (same pattern as GrinderDetailView Picker binding to raw String). Picker for processingMethod bound to `$bean.processingMethod` same pattern. DatePicker for roastDate (if non-nil). Show FreshnessIndicatorView(roastDate: bean.roastDate) in this section.
         - "Notes" section: TextEditor for notes
         - "Info" section: LabeledContent "Created" with date, archive toggle Button ("Archive" / "Unarchive")
       - `.navigationTitle(bean.displayName)`
       - Add `.onChange` modifiers on key editable fields (roaster, origin, roastLevel, processingMethod, notes) to update `bean.updatedAt = Date()` -- same pattern as GrinderDetailView
       - For the roastDate field: use a Toggle + DatePicker pattern. If bean.roastDate is nil, show a Button "Set Roast Date" that sets it to Date(). If non-nil, show DatePicker bound to a non-optional binding (use Binding with get/set that unwraps roastDate with a fallback) plus a "Clear" button to set back to nil.
  </action>
  <verify>
    `swift build` compiles without errors. All five view files exist in CoffeeJournal/Views/Beans/. BeanListView uses parent/child @Query pattern with #Predicate. AddBeanView has Cancel/Save toolbar. BeanDetailView uses @Bindable pattern.
  </verify>
  <done>
    Complete bean CRUD UI: list with search-by-roaster-or-origin and active/archived segmented filter, add form with all BEAN-01 fields, detail/edit view with photos and freshness indicator. Swipe-to-archive and swipe-to-delete on list rows.
  </done>
</task>

<task type="auto">
  <name>Task 3: Wire Beans tab into MainTabView</name>
  <files>
    CoffeeJournal/Views/MainTabView.swift
  </files>
  <action>
    Modify MainTabView.swift to add a Beans tab as the FIRST tab (before Methods and Grinders), per research recommendation that beans are the most frequently accessed entity.

    Updated tab order:
    1. **Beans** -- NavigationStack { BeanListView() } with tabItem Label("Beans", systemImage: "leaf")
    2. **Methods** -- existing (unchanged)
    3. **Grinders** -- existing (unchanged)
    4. **Settings** -- existing (unchanged)

    Keep existing `.tint(Color.primary)` for monochrome tab icons. Do not modify any other files.
  </action>
  <verify>
    `swift build` compiles. MainTabView shows 4 tabs with Beans first. Navigating to Beans tab shows BeanListView with empty state.
  </verify>
  <done>
    Beans tab appears as the first tab in the app. Full navigation flow works: Beans tab -> BeanListView -> Add Bean (sheet) -> BeanDetailView (push). The bean management feature is fully accessible from the main app.
  </done>
</task>

</tasks>

<verification>
1. `swift build` passes with zero errors
2. BeanListView loads with empty state when no beans exist
3. Adding a bean via AddBeanView persists it to SwiftData and it appears in the list
4. Tapping a bean row navigates to BeanDetailView with all fields editable
5. Search bar filters beans by roaster or origin (parent/child @Query reinitializes on search text change)
6. Active/Archived segmented picker toggles between showing active and archived beans
7. Swipe-to-archive moves a bean between active and archived lists
8. Swipe-to-delete removes a bean permanently
9. FreshnessIndicatorView shows correct icon, days count, and opacity based on roast date
10. Photos can be added/changed/removed in BeanDetailView using EquipmentPhotoPickerView
11. Beans tab appears first in MainTabView with leaf icon
</verification>

<success_criteria>
- All BEAN-01 fields (roaster, origin, region, variety, processing method, roast level) can be entered and edited
- Days since roast displays correctly with monochrome freshness indicator (BEAN-02, BEAN-06)
- Photos work on bean entries via reused EquipmentPhotoPickerView (BEAN-03)
- Beans can be archived and unarchived (BEAN-04)
- Search by roaster or origin filters the list at database level (BEAN-07)
- CloudKit sync is automatic via existing SwiftData configuration (BEAN-08)
</success_criteria>

<output>
After completion, create `.planning/phases/02-coffee-bean-tracking/02-01-SUMMARY.md`
</output>
