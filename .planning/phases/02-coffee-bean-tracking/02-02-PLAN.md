---
phase: 02-coffee-bean-tracking
plan: 02
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - CoffeeJournal/Utilities/BagLabelParser.swift
  - CoffeeJournal/Views/Scanner/BagScannerView.swift
  - CoffeeJournal/Views/Scanner/ScanResultReviewView.swift
  - CoffeeJournal/Views/Beans/BeanListView.swift
  - CoffeeJournal/Info.plist
autonomous: true

must_haves:
  truths:
    - "User can scan a coffee bag label with their camera and see recognized text parsed into structured fields"
    - "User can review and correct auto-extracted fields (roaster, origin, variety, roast date) before saving"
    - "Scan option appears only on devices that support DataScannerViewController"
    - "On unsupported devices, user can still add beans manually (no crash, no broken UI)"
  artifacts:
    - path: "CoffeeJournal/Utilities/BagLabelParser.swift"
      provides: "Heuristic text-to-fields extraction with known origins, varieties, date patterns"
      contains: "struct BagLabelParser"
    - path: "CoffeeJournal/Views/Scanner/BagScannerView.swift"
      provides: "UIViewControllerRepresentable wrapping DataScannerViewController"
      contains: "struct BagScannerView"
    - path: "CoffeeJournal/Views/Scanner/ScanResultReviewView.swift"
      provides: "Review/edit form for OCR-extracted fields before creating bean"
      contains: "struct ScanResultReviewView"
  key_links:
    - from: "CoffeeJournal/Views/Beans/BeanListView.swift"
      to: "CoffeeJournal/Views/Scanner/BagScannerView.swift"
      via: "Sheet presentation from toolbar Menu scan option"
      pattern: "BagScannerView"
    - from: "CoffeeJournal/Views/Scanner/BagScannerView.swift"
      to: "CoffeeJournal/Utilities/BagLabelParser.swift"
      via: "Parsing recognized text into ParsedBagLabel struct"
      pattern: "BagLabelParser\\.parse"
    - from: "CoffeeJournal/Views/Scanner/BagScannerView.swift"
      to: "CoffeeJournal/Views/Scanner/ScanResultReviewView.swift"
      via: "Navigation push after scanning completes"
      pattern: "ScanResultReviewView"
    - from: "CoffeeJournal/Views/Scanner/ScanResultReviewView.swift"
      to: "CoffeeJournal/Models/CoffeeBean.swift"
      via: "Creating and inserting CoffeeBean from reviewed fields"
      pattern: "modelContext\\.insert"
---

<objective>
Add camera-based bag label scanning (OCR) to the bean management flow, allowing users to scan a coffee bag and have roaster, origin, variety, and roast date auto-extracted for review.

Purpose: Delivers requirement BEAN-05 (scan coffee bag labels with camera to auto-extract fields). The only genuinely new technology in Phase 2 -- VisionKit DataScannerViewController for live text recognition with heuristic parsing.
Output: Working scan flow integrated into BeanListView toolbar, producing pre-filled bean entries for user review.
</objective>

<execution_context>
@/Users/ashok/.claude/get-shit-done/workflows/execute-plan.md
@/Users/ashok/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-coffee-bean-tracking/02-RESEARCH.md
@.planning/phases/02-coffee-bean-tracking/02-01-SUMMARY.md

Key codebase files:
@CoffeeJournal/Models/CoffeeBean.swift
@CoffeeJournal/Models/RoastLevel.swift
@CoffeeJournal/Models/ProcessingMethod.swift
@CoffeeJournal/Views/Beans/BeanListView.swift
@CoffeeJournal/Views/Beans/AddBeanView.swift
</context>

<tasks>

<task type="auto">
  <name>Task 1: BagLabelParser and BagScannerView</name>
  <files>
    CoffeeJournal/Utilities/BagLabelParser.swift
    CoffeeJournal/Views/Scanner/BagScannerView.swift
  </files>
  <action>
    Create TWO new files:

    1. **BagLabelParser.swift** (new, in Utilities/):
       - Define `struct ParsedBagLabel` with optional fields: `roaster: String?`, `origin: String?`, `region: String?`, `variety: String?`, `roastDate: Date?`, `roastLevel: String?`, `processingMethod: String?`
       - Define `struct BagLabelParser` with static methods:
         - `static func parse(recognizedTexts: [String]) -> ParsedBagLabel`
         - Join all recognized text lines, then apply heuristics:
           - **Origin detection**: Match against `knownOrigins` array (25+ coffee-producing countries: Ethiopia, Colombia, Brazil, Kenya, Guatemala, Costa Rica, Honduras, Peru, Rwanda, Burundi, Indonesia, Sumatra, Java, Papua New Guinea, Mexico, El Salvador, Nicaragua, Panama, Tanzania, Uganda, DR Congo, Malawi, India, Yemen, Vietnam). Use `localizedCaseInsensitiveContains` for matching.
           - **Variety detection**: Match against `knownVarieties` array (Bourbon, Typica, Caturra, Catuai, SL28, SL34, Gesha, Geisha, Pacamara, Maragogype, Heirloom, Castillo, Colombia, Catimor, Pink Bourbon).
           - **Roast level detection**: Match keywords "light", "medium-light", "medium light", "medium", "medium-dark", "medium dark", "dark", "espresso roast", "filter roast", "omni roast" to RoastLevel raw values.
           - **Processing method detection**: Match keywords "washed", "wet process", "natural", "dry process", "honey", "honey process", "anaerobic" to ProcessingMethod raw values.
           - **Date extraction**: `extractDate(from:)` private method using regex patterns for common date formats (MM/DD/YYYY, DD.MM.YYYY, DD-MM-YYYY, YYYY-MM-DD) plus spelled-out formats ("January 15, 2026", "Jan 15, 2026"). Create DateFormatters with `Locale(identifier: "en_US_POSIX")`. Sanity check: date must be within last 2 years and not in the future.
           - **Roaster guess**: Use the first recognized text line as the roaster name (heuristic -- coffee bag labels often have the roaster name most prominently at top). This is a suggestion, not a certainty.
       - All heuristics are best-effort. The parser is a suggestion system, not a data entry system. The review screen (Task 2) is where the user confirms/corrects.

    2. **BagScannerView.swift** (new, in Views/Scanner/):
       - `import VisionKit` and `import SwiftUI`
       - Create a container view `struct BagScannerSheet: View` that manages the scanning flow state:
         - `@Environment(\.dismiss) private var dismiss`
         - `@Environment(\.modelContext) private var modelContext`
         - `@State private var recognizedTexts: [String] = []`
         - `@State private var scanComplete = false`
         - `@State private var parsedLabel: ParsedBagLabel?`
         - Body: NavigationStack containing either the scanner or the review screen
         - When `scanComplete == false`: show `BagScannerCameraView(recognizedTexts: $recognizedTexts, onCapture: { ... })` with a toolbar "Done Scanning" button
         - When user taps "Done Scanning": parse with `BagLabelParser.parse(recognizedTexts:)`, set `parsedLabel`, set `scanComplete = true`, navigate to ScanResultReviewView
       - Create `struct BagScannerCameraView: UIViewControllerRepresentable`:
         - Wraps `DataScannerViewController(recognizedDataTypes: [.text()], qualityLevel: .accurate, recognizesMultipleItems: true, isHighlightingEnabled: true)`
         - Coordinator implements `DataScannerViewControllerDelegate`
         - In `makeUIViewController`: create and return the DataScannerViewController
         - In `updateUIViewController`: call `try? uiViewController.startScanning()` (safe to call repeatedly)
         - Coordinator captures recognized text items. Use `dataScanner(_:didAdd:)` delegate method to accumulate `RecognizedItem.text` transcripts into the `recognizedTexts` binding. Avoid duplicates by checking if transcript already exists.
         - `static func dismantleUIViewController`: call `stopScanning()` on the controller
       - The scanner should show recognized text with highlighting (built into DataScannerViewController). User points camera at bag, sees text highlights, taps "Done Scanning" when satisfied.
  </action>
  <verify>
    `swift build` compiles without errors. Both files exist at expected paths. BagLabelParser.parse returns a ParsedBagLabel from test input strings. BagScannerCameraView conforms to UIViewControllerRepresentable.
  </verify>
  <done>
    BagLabelParser extracts structured coffee fields from raw text using heuristic matching. BagScannerCameraView wraps DataScannerViewController for live camera text recognition. BagScannerSheet manages the scan-to-review flow.
  </done>
</task>

<task type="auto">
  <name>Task 2: ScanResultReviewView, Info.plist camera permission, and BeanListView toolbar integration</name>
  <files>
    CoffeeJournal/Views/Scanner/ScanResultReviewView.swift
    CoffeeJournal/Info.plist
    CoffeeJournal/Views/Beans/BeanListView.swift
  </files>
  <action>
    Create ONE new file and modify TWO existing files:

    1. **ScanResultReviewView.swift** (new, in Views/Scanner/):
       - Accepts `let parsedLabel: ParsedBagLabel` and provides editable fields pre-filled from parser output
       - `@Environment(\.modelContext) private var modelContext`
       - `@Environment(\.dismiss) private var dismiss`
       - `@State` properties initialized from parsedLabel: `roaster`, `origin`, `region`, `variety`, `roastLevel` (RoastLevel), `processingMethod` (ProcessingMethod), `roastDate` (Date?), `notes` ("")
       - In `init(parsedLabel:)`: initialize all @State wrappers from parsedLabel fields, converting roastLevel/processingMethod strings to enum values with fallbacks
       - Form layout (matches AddBeanView structure for consistency):
         - Section header "Scanned Results" with a caption text: "Review and correct the extracted information" in AppTypography.caption, AppColors.subtle
         - "Coffee Info": TextField for roaster, TextField for origin
         - "Origin Details": TextField for region, TextField for variety
         - "Roast": Picker for roastLevel, Picker for processingMethod, optional DatePicker for roastDate (same Toggle+DatePicker pattern as AddBeanView)
         - "Notes": TextField for notes (multiline)
       - `canSave` computed: roaster or origin must be non-empty (same validation as AddBeanView)
       - Save function: create CoffeeBean(), assign all reviewed fields, insert into modelContext, dismiss the entire scanner sheet (use dismiss environment)
       - Toolbar: Cancel (leading, dismisses), Save (trailing, disabled when !canSave, label "Save Coffee")
       - `.navigationTitle("Review Scan")`

    2. **Info.plist** (create or modify):
       - Add `NSCameraUsageDescription` key with value "Coffee Journal uses your camera to scan coffee bag labels and extract roaster, origin, and roast date information."
       - If Info.plist doesn't exist yet (Xcode projects may use build settings instead), check if there's an existing Info.plist in the CoffeeJournal directory. If not, check for a `INFOPLIST_FILE` build setting or an `Info.plist` target. If the project uses the modern Xcode automatic Info.plist generation (no explicit file), then add the camera usage description to the Xcode project's build settings. The simplest approach: create `CoffeeJournal/Info.plist` with the standard XML plist structure containing just the `NSCameraUsageDescription` key. Also ensure the Package.swift or project references it if needed.
       - NOTE: If the project structure doesn't use Info.plist (pure SwiftPM), the camera permission description can alternatively be set via an `InfoPlist.xcprivacy` file or by adding it to the target's Info settings. Examine the actual project structure first and choose the approach that fits.

    3. **BeanListView.swift** (modify existing from Plan 01):
       - Change the toolbar "plus" Button to a **Menu** that offers two options:
         - "Add Manually" (systemImage: "plus") -- sets `showingAddSheet = true` (existing behavior)
         - "Scan Bag Label" (systemImage: "camera.viewfinder") -- sets a new `@State private var showingScanner = false` to true. This option should ONLY appear when `DataScannerViewController.isSupported` is true (guard with an `if` inside the Menu).
       - Menu label: `Image(systemName: "plus").foregroundStyle(AppColors.primary)`
       - Add `import VisionKit` at the top of the file
       - Add a second `.sheet(isPresented: $showingScanner)` presenting `BagScannerSheet()`
       - IMPORTANT: On devices where DataScannerViewController.isSupported is false, the Menu should only show "Add Manually" (effectively behaving like the original single button). This is not a crash -- just a graceful feature absence.
  </action>
  <verify>
    `swift build` compiles without errors. ScanResultReviewView exists with pre-filled form fields. BeanListView toolbar shows Menu with "Add Manually" and conditionally "Scan Bag Label". NSCameraUsageDescription is configured.
  </verify>
  <done>
    Complete OCR flow: user taps "Scan Bag Label" in BeanListView toolbar -> camera scanner opens -> user scans bag -> taps "Done Scanning" -> review screen shows extracted fields -> user corrects and saves. On unsupported devices, only "Add Manually" appears. Camera permission description is configured.
  </done>
</task>

</tasks>

<verification>
1. `swift build` passes with zero errors
2. BeanListView toolbar shows Menu with "Add Manually" option (always) and "Scan Bag Label" option (conditionally, when DataScannerViewController.isSupported)
3. Tapping "Add Manually" opens the existing AddBeanView sheet (unchanged from Plan 01)
4. Tapping "Scan Bag Label" opens the BagScannerSheet with live camera scanner
5. Scanner shows recognized text highlights on the camera feed
6. Tapping "Done Scanning" parses recognized text and navigates to ScanResultReviewView
7. ScanResultReviewView pre-fills fields from parser output (roaster, origin, variety, roast date, etc.)
8. User can edit all pre-filled fields before saving
9. Saving creates a CoffeeBean with the reviewed fields and dismisses the scanner
10. NSCameraUsageDescription appears in the camera permission dialog
11. On devices without DataScannerViewController support, no crash occurs and scan option is hidden
</verification>

<success_criteria>
- BEAN-05 complete: user can scan a coffee bag label with camera and have roaster, origin, variety, and roast date auto-populated
- OCR results are always presented for user review/correction before saving (no auto-save)
- Scan feature degrades gracefully on unsupported devices (hidden, not broken)
- Camera permission description is properly configured
- BagLabelParser handles common coffee label patterns (country names, date formats, roast levels, varieties)
</success_criteria>

<output>
After completion, create `.planning/phases/02-coffee-bean-tracking/02-02-SUMMARY.md`
</output>
