---
phase: 04-tasting-flavor-notes
plan: 03
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - CoffeeJournal/Views/Tasting/SpiderChartView.swift
  - CoffeeJournal/Views/Tasting/FlavorProfileView.swift
  - CoffeeJournal/Views/Tasting/BrewComparisonView.swift
  - CoffeeJournal/Views/Brewing/BrewLogDetailView.swift
  - CoffeeJournal/Views/Brewing/BrewLogListView.swift
  - Package.swift
autonomous: true

must_haves:
  truths:
    - "User can view a flavor profile visualization (spider chart and tag cloud) for any brew with tasting notes"
    - "User can compare tasting notes side-by-side for two different brews"
    - "Flavor profile shows attribute ratings visually and flavor tags as a tag cloud"
  artifacts:
    - path: "CoffeeJournal/Views/Tasting/SpiderChartView.swift"
      provides: "Radar/spider chart Shape for tasting attribute visualization"
      contains: "struct SpiderChartView"
      min_lines: 50
    - path: "CoffeeJournal/Views/Tasting/FlavorProfileView.swift"
      provides: "Combined visualization: spider chart + flavor tag cloud for a single brew"
      contains: "struct FlavorProfileView"
    - path: "CoffeeJournal/Views/Tasting/BrewComparisonView.swift"
      provides: "Side-by-side comparison of two brews' tasting notes"
      contains: "struct BrewComparisonView"
      min_lines: 80
  key_links:
    - from: "CoffeeJournal/Views/Tasting/FlavorProfileView.swift"
      to: "CoffeeJournal/Views/Tasting/SpiderChartView.swift"
      via: "embeds SpiderChartView for attribute visualization"
      pattern: "SpiderChartView"
    - from: "CoffeeJournal/Views/Brewing/BrewLogDetailView.swift"
      to: "CoffeeJournal/Views/Tasting/FlavorProfileView.swift"
      via: "NavigationLink to flavor profile view"
      pattern: "FlavorProfileView"
    - from: "CoffeeJournal/Views/Tasting/BrewComparisonView.swift"
      to: "CoffeeJournal/Models/TastingNote.swift"
      via: "reads tasting attributes and flavor tags from two BrewLog instances"
      pattern: "tastingNote"
---

<objective>
Build flavor profile visualizations (spider chart + tag cloud) and the side-by-side brew comparison view.

Purpose: Fulfills TASTE-05 (flavor profile visualization) and TASTE-06 (side-by-side brew comparison). Users can see their tasting data rendered visually as a radar chart and tag cloud, and compare two brews to understand how they differ across tasting attributes and flavor profiles.

Output: SpiderChartView for attribute visualization, FlavorProfileView combining chart + tags, BrewComparisonView for side-by-side comparison, all wired into the brew detail navigation flow.
</objective>

<execution_context>
@/Users/ashok/.claude/get-shit-done/workflows/execute-plan.md
@/Users/ashok/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-tasting-flavor-notes/04-RESEARCH.md
@.planning/phases/04-tasting-flavor-notes/04-01-SUMMARY.md

# Source files this plan reads/modifies
@CoffeeJournal/Models/FlavorWheel.swift
@CoffeeJournal/Models/TastingNote.swift
@CoffeeJournal/Models/BrewLog.swift
@CoffeeJournal/Views/Brewing/BrewLogDetailView.swift
@CoffeeJournal/Views/Brewing/BrewLogListView.swift
@CoffeeJournal/Views/Tasting/FlavorTagFlowView.swift
@CoffeeJournal/Views/Components/MonochromeStyle.swift
@Package.swift
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create SpiderChartView and FlavorProfileView</name>
  <files>
    CoffeeJournal/Views/Tasting/SpiderChartView.swift
    CoffeeJournal/Views/Tasting/FlavorProfileView.swift
    CoffeeJournal/Views/Brewing/BrewLogDetailView.swift
    Package.swift
  </files>
  <action>
**1. Create SpiderChartView.swift** -- Radar chart for tasting attributes:

Define `struct RadarChartShape: Shape` with `let data: [Double]` (values 0.0-1.0 per axis) and `let axisCount: Int`. The `path(in:)` method draws a closed polygon by placing points at equal angular intervals around the center, each at a distance proportional to its data value.

Define `struct SpiderChartView: View` with properties:
- `let values: [Double]` -- normalized values (0.0-1.0) for each axis
- `let labels: [String]` -- label for each axis
- `let gridLevels: Int = 5` -- concentric rings

Layout in GeometryReader:
- Draw concentric grid polygons (1/5, 2/5, 3/5, 4/5, 5/5 of radius) stroked with AppColors.muted at 0.5 lineWidth
- Draw axis lines from center to each vertex at full radius, stroked with AppColors.muted at 0.5 lineWidth
- Draw the data polygon: filled with AppColors.primary.opacity(0.15), stroked with AppColors.primary at lineWidth 2
- Draw data points as small circles (radius 4) at each vertex in AppColors.primary
- Draw labels at each axis endpoint, positioned slightly beyond the outer grid ring. Use AppTypography.caption font. Position labels using the angle to avoid overlap (top labels above, bottom labels below, side labels to the side).

**Research note on 3-axis charts:** The spider chart with 3 axes (acidity, body, sweetness) will look triangular. This is acceptable -- the shape clearly shows the balance between attributes. The RadarChartShape supports any axis count, so if more attributes are added later, the chart adapts automatically. Add a convenience initializer for TastingNote data:

```swift
static func fromTastingNote(_ note: TastingNote) -> SpiderChartView {
    SpiderChartView(
        values: [Double(note.acidity) / 5.0, Double(note.body) / 5.0, Double(note.sweetness) / 5.0],
        labels: ["Acidity", "Body", "Sweetness"]
    )
}
```

**2. Create FlavorProfileView.swift** -- Combined visualization for a single brew:

`struct FlavorProfileView: View` with `let brewLog: BrewLog`.

Layout as ScrollView with VStack:
- **Title:** "Flavor Profile" as navigation title
- **Spider Chart section:** If tastingNote has any rated attribute (acidity/body/sweetness > 0), show SpiderChartView.fromTastingNote(note) in a fixed frame (250x250). Below it, show the attribute values as text: "Acidity: N/5  Body: N/5  Sweetness: N/5" in a horizontal layout for precise reference.
- **Flavor Tags section:** If tastingNote has decoded flavor tags (non-empty flavorTags JSON), show them as a FlavorTagFlowView (read-only, all marked as selected, no toggle/remove actions). Use AppTypography.headline for the section header "Flavor Notes".
- **Freeform Notes section:** If tastingNote.freeformNotes is non-empty, show the text with AppTypography.body font.
- **Empty state:** If brewLog.tastingNote is nil, show a centered message "No tasting notes yet" with a NavigationLink to TastingNoteEntryView.

Use monochrome styling throughout -- AppColors.primary for the spider chart fill, AppColors.muted for grid lines, no color.

**3. Update BrewLogDetailView.swift** -- Add FlavorProfileView navigation:

In the existing tastingNotesSection (added in Plan 01), add a NavigationLink to FlavorProfileView(brewLog: brew) labeled "View Flavor Profile" (only visible when tastingNote exists and has at least one rated attribute or flavor tag). Use a NavigationLink with a label showing a small inline spider chart preview or just a "chart.bar" SF Symbol icon with "Flavor Profile" text.

**4. Update Package.swift** -- Add new source files:
- "Views/Tasting/SpiderChartView.swift"
- "Views/Tasting/FlavorProfileView.swift"
  </action>
  <verify>
Run `swift build` from the project root. Verify:
- RadarChartShape conforms to Shape protocol
- SpiderChartView renders with values, labels, and grid levels
- SpiderChartView.fromTastingNote convenience constructor works
- FlavorProfileView shows spider chart + flavor tags + notes
- BrewLogDetailView has NavigationLink to FlavorProfileView
  </verify>
  <done>
SpiderChartView renders a monochrome radar chart for tasting attributes. FlavorProfileView combines the chart with flavor tags and notes in a single scrollable view. BrewLogDetailView links to the flavor profile when tasting data exists.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create BrewComparisonView and wire navigation</name>
  <files>
    CoffeeJournal/Views/Tasting/BrewComparisonView.swift
    CoffeeJournal/Views/Brewing/BrewLogListView.swift
    Package.swift
  </files>
  <action>
**1. Create BrewComparisonView.swift** -- Side-by-side brew comparison:

`struct BrewComparisonView: View` with `@Query(sort: \BrewLog.createdAt, order: .reverse) private var allBrews: [BrewLog]`. State:
- `@State private var brewA: BrewLog?`
- `@State private var brewB: BrewLog?`
- `@State private var showingPickerForSide: ComparisonSide?` (enum: .left, .right)

Define `enum ComparisonSide { case left, right }`.

**Layout:**
NavigationStack with ScrollView containing:

- **Brew Selectors:** HStack with two VStack columns, each showing:
  - A Button that sets showingPickerForSide to the appropriate side
  - When a brew is selected: show the coffee name, method name, and date in compact format
  - When not selected: show "Select Brew" placeholder with "plus.circle" icon
  - Divider between columns

- **Attribute Comparison:** (visible when both brews have tastingNotes)
  Section "Tasting Attributes" showing a comparison grid:
  For each attribute (Acidity, Body, Sweetness):
  - Row with: brewA value (left-aligned) | attribute label (centered) | brewB value (right-aligned)
  - Below the values, show a mini horizontal bar or just the numeric "N/5" format

  Then show two SpiderChartViews side by side (each in a compact frame ~150x150) for visual comparison of attribute profiles.

- **Flavor Comparison:** (visible when either brew has flavor tags)
  Section "Flavor Notes" showing:
  - Left column: FlavorTagFlowView of brewA's decoded flavor tags (read-only)
  - Right column: FlavorTagFlowView of brewB's decoded flavor tags (read-only)
  - Optionally highlight shared flavors (tags present in both) with a different opacity level

- **Parameters Comparison:** Quick reference comparison:
  Rows for: Dose, Water, Ratio, Brew Time, Rating -- each showing brewA value | label | brewB value

- **Picker Sheet:** Present a `.sheet` when showingPickerForSide is non-nil. The sheet shows a simple List of allBrews (filtered to exclude the already-selected other brew). Each row shows coffee name, method, date. Tapping a row sets the appropriate brewA or brewB and dismisses the sheet.

**Brew data decoding helper:** Add a private method `func decodedFlavorTags(for note: TastingNote) -> [(id: String, name: String)]` that decodes the JSON flavorTags string and maps IDs to display names using FlavorWheel.findNode(byId:). Custom tags (prefixed "custom:") display with the prefix stripped.

**Monochrome styling:** Use AppColors throughout. No color differentiation between left/right -- use position only. Headers can use AppTypography.headline, values use AppTypography.body.

**2. Wire navigation from BrewLogListView:**

Add a toolbar button to BrewLogListView -- a NavigationLink with SF Symbol "arrow.left.arrow.right" or a toolbar item labeled "Compare" that navigates to BrewComparisonView(). Only show the compare button when there are at least 2 brews (check allBrews.count >= 2 -- you may need to add a @Query to BrewLogListView or its parent for this, or simply always show it and let the comparison view handle the empty state).

**3. Update Package.swift** -- Add:
- "Views/Tasting/BrewComparisonView.swift"
  </action>
  <verify>
Run `swift build` from the project root. Verify:
- BrewComparisonView has brew picker for left and right sides
- Attribute comparison shows side-by-side values and SpiderChartViews
- Flavor tag comparison shows decoded tags for both brews
- BrewLogListView has navigation to BrewComparisonView
- Package.swift includes all new files
  </verify>
  <done>
Users can navigate to BrewComparisonView from the brew list, select two brews, and see their tasting attributes, flavor tags, and parameters compared side by side with spider charts for visual differentiation.
  </done>
</task>

</tasks>

<verification>
1. SpiderChartView renders a 3-axis radar chart for acidity/body/sweetness values
2. FlavorProfileView combines spider chart with flavor tag cloud and notes
3. BrewLogDetailView links to FlavorProfileView when tasting data exists
4. BrewComparisonView allows selecting two brews and shows side-by-side comparison
5. Attribute values, spider charts, flavor tags, and parameters all appear in comparison
6. BrewLogListView has toolbar navigation to BrewComparisonView
7. All views use monochrome styling consistent with design system
8. All new files added to Package.swift and project compiles with `swift build`
</verification>

<success_criteria>
- Spider chart displays monochrome radar visualization for 3 tasting attributes
- Flavor profile view shows spider chart + tag cloud for any brew with tasting data
- Brew comparison allows selecting two brews and comparing all tasting data side-by-side
- Navigation wired: detail view links to profile, list view links to comparison
- Monochrome design maintained throughout all visualizations
</success_criteria>

<output>
After completion, create `.planning/phases/04-tasting-flavor-notes/04-03-SUMMARY.md`
</output>
